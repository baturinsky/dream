(()=>{function f(e,t,n=1){return e.map((o,r)=>o+t[r]*n)}function Et(e,t=1){return e.map((n,o)=>n*t)}function de(e,t){return f(e,t,-1)}function hn(e){return e.reduce((t,n)=>t+n*n,0)**.5}function he(e,t){return hn(de(t,e))}var Ye=2**31,c=Fe(123);function Fe(e=0){0<e&&e<1&&(e=~~(e*Ye));let t=n=>(e=e*16807%2147483647)%n;return c=n=>n==-1?e:n==null?t(Ye)/Ye:t(n),c}function S(e,t=c){if(!e)return null;let n=t(e.length);return e[n]}function V(e,t=c){let n=je(e),o=t()*n-e[0],r=0;for(;o>=0;)o-=e[++r];return r}function Ne(e,t,n=c){let o=e.map(t),r=V(o);return e[r]}function Y(e,t=o=>o,n=c){let o=V(Object.values(e).map(t),n);return Object.keys(e)[o]}function je(e){return e.reduce((t,n)=>t- -n,0)}function vt(e=c){let t="";for(let n=0;n<e(3)+2;n++)t+=S([..."kstnhmyrw",""],e)+S([..."aiueo",""],e);return bn(t)}function bn(e){return e?e[0].toUpperCase()+e.substring(1):""}function ne(e){for(let t of Object.values(e))for(let n in t){let o=Number(t[n]);!isNaN(o)&&n!="colors"&&(t[n]=o)}return e}function oe(e,t=c){return e=e*100,e=(e%1>t()?1:0)+~~e,e/=100}function H(e,t=n=>n){return[...new Array(~~Math.max(e,0))].map((n,o)=>t(o))}var Ze=e=>new Promise(t=>setTimeout(t,e));var w=ne(Object.fromEntries(`Health:So called Hit Points:31
Strength:Dealing Damage:fg
Resilience:Damage reduction:qp
Greed:Find More:c4
Bloom:Regeneration:ba
Courage:Cover your allies:21
Anger:Avenge Damage:uv
Mercy:Heal Friends:lx
Knowledge:Writing and Reading:mn
Light:Strike True:je
Dark:Evade:o8
Time:Action Rate:lm
Purity:Resist Poison:rq
Venom:Poison:ba`.split(`
`).map((e,t)=>{let[n,o,r]=e.split(":"),i=n[0];return[i,{l:i,name:n,tip:o,colors:r,ind:t}]}))),R=ne(Object.fromEntries(`Wooden:67:H:10
Iron:32:S:10
Stone:mn:R:10
Golden:c4:G:2
Plant:ba:B:5
Leather:56:C:5
Bone:ji:A:5
Cloth:tv:M:10
Paper:kl:K:5
Glass:wr:L:5
Obsidian:no:D:2
Copper:ef:T:5
Silver:lx:P:3
Asbestos:kb:V:1
Abstract:::1`.split(`
`).map(e=>{let[t,n,o,r]=e.split(":");return[t,{colors:n,aspects:ge(o),chance:r}]}))),J=ne(Object.fromEntries(`Door:2:10:Wooden:0:1:
Bed:2:H:Wooden:10:.5:
Column:3:R:Stone:0:1:
Apple:1:B:Plant:10:1:
Chair:2:H:Wooden:10:.5:
Chest:1:G:Wooden:10:1:
Shelf:2:G:Wooden:0:1:
Stand:2::Stone:0:1:
Display:2::Glass:0:1:
Plaque:2::Iron:0:1:
Big Table:2:R:Stone:0:1:
Display:2::Glass:0:1:
Dial:2::Glass:0:1:
Table:2::Wooden:10:.5:
Clock:1:T:Golden:1:1:
Pedestal:1::Wooden::1:
Mirror:2::Glass:5:1:
Angel:2:P:Silver:3:1:
Press:2::Iron:0:1:
Brush:1:::0:1:
Wine:1:A:Plant:5:1:
`.split(`
`).map((e,t)=>{let[n,o,r,i,a,s]=e.split(":");return[n,{name:n,scale:o,aspects:ge(r),material:i,chance:a??0,ind:t,placeh:s}]}))),ye=ne(Object.fromEntries(`Human:G
Elf:B
Cat:D
Ogre:H
Fairy:M
Bird:L
Rat:D
Raven:A
Skel:C
Imp:V
Dog:S
Hippo:H
Lizard:B
Drago:P
Alien:K
Hare:T`.split(`
`).map((e,t)=>{let[n,o]=e.split(":");return[n,{name:n,aspects:ge(o),ind:t,chance:1/(10+t)}]}))),Tt={...ye,...J};var ze={1:"LMB to switch current character, walk around and pick/place items. RMB to use items (such as Bed).",2:"An item that you have found in the dream. Looking at it (happens automatically when awake) can help to remember something about reality (i.e. raise aspects).",Bed:"RMB to sleep. You can increase your level and find some items in dreams. What you find in the dream is affected by the room number and the aspects of the bed and the dreamer.",Brush:"Can recolor items"};function ge(e=""){let t={};return[...e].forEach(n=>t[n]=(t[n]||0)+1),t}function xe(e,t,n=1){let o={};e??={},t??={};for(let r in{...e,...t})o[r]=(e[r]||0)+(t[r]||0)*n;return o}function St(e){let t="";for(let n of Object.keys(w).sort((o,r)=>e[o]-e[r]))e[n]>0&&(t+=`<div class="aspect" data-aspect=${n}><span class=num>${e[n].toFixed(2).replace(/(.00)/g,"")}<span> ${w[n].name} <i>${w[n].tip}</i></div>`);return t}function Z(e){return je(Object.values(e))}function Ge(e,t,n){e[t]=(e[t]||0)+n}function wt(e,t,n=1){let o=Z(e),r={...e};return H((t-o)/n).forEach(i=>{let a=c(4)?Y(r):S(Object.keys(w));Ge(r,a,n)}),r}var Ee=0;function At(e){Ee=e}function Lt(){return++Ee}var A=256*2,x=128*2,Jn=64*2-1,We=(e,t,n)=>yn(En(n,e),t),L=(e,t)=>We("S",e,t),Ct=(e,t)=>We("T",e,t),U=(e,t)=>We("O",e,t);function yn(e,t){if(!e)debugger;if(!t)return e;let n=e.cloneNode();return d(n).filter=vn(t),d(n).drawImage(e,0,0),n}var ve=32,gn=48,xn=64;var qe=112;var Te=144,kt=xn,Pt=gn,Mt=16;function En(e,t,n=0){t=="O"&&(n=1);let o=Qe(8+n*2);return o.id=t+e,d(o).filter=`url(#_${t})`,d(o).drawImage(img,e%Mt*8,~~(e/Mt)*8,8,8,n,n,8,8),o}function d(e){return e.getContext("2d")}function vn(e){if(!Ke.has(e)){Ke.add(e);let[t,n]=[...e].map(r=>be[Number.parseInt(r,36)]),o=`<filter id=f${e}><feColorMatrix type=matrix values="${t[0]} ${n[0]} 0 0 0  ${t[1]} ${n[1]} 0 0 0  ${t[2]} ${n[2]} 0 0 0  0 0 0 1 0" /></filter>`;DEFS.innerHTML+=o}return`url(#f${e})`}function Qe(e,t=e){let n=document.createElement("canvas");return n.classList.add("sprite"),n.width=e,n.height=t,n}var v=e=>d(e).createPattern(e,"repeat");function Ve(e,t,n){let o=document.createElement("div");o.classList.add("ftext"),n&&o.classList.add(n),o.innerHTML=`<div>${e}</div>`,Scene.appendChild(o),setTimeout(()=>Scene.removeChild(o),3e3),Je(o,t)}function Je(e,t,n=""){Object.assign(e.style,Ue(t,n))}function Ue(e,t=""){return{left:`${e[0]}px`,top:`${e[2]}px`,transform:`translateZ(${e[1]}px) `+t}}function b(e,t,n,o=1){let r=d(e);o&&(r.globalAlpha=o),r.fillStyle=t,r.fillRect(...n||[0,0,e.width,e.height]),o&&(r.globalAlpha=1)}function G(e,t,n,o=1){return e.width=t*o,e.height=n*o,e.style.width=`${t}px`,e.style.height=`${n}px`,e}function _(e,t,n,o="canvas"){let r=document.createElement(o);return r.id=e,r.classList.add(...t.split(",")),Object.assign(r.style,n),Scene.appendChild(r),r}function Dt(e,t){let n=e.cloneNode();return n.width*=t,n.height*=t,Se(n,e,0,0,t),n}function Se(e,t,n,o,r=1){d(e).imageSmoothingEnabled=!1,d(e).drawImage(t,n,o,t.width*r,t.height*r)}var Tn,Ae,et;function Ht(){let e="";Scene.innerHTML+=e,G(Back,256*3,128*5,2);let t=v(L("gf",2));Tn=H(3+1,o=>{let r=_(`w${o}`,"wall",{left:`${o*256}px`});return G(r,64,128*5,2),b(r,t),r}),Ae=H(5+1,o=>G(_(`f${o-1}`,"floor",{top:`${o*128}px`}),256*3,64,2));let n=Ae.shift();b(n,v(L("87",2))),n.style.pointerEvents="none",et=H(15,o=>G(_(`c${o}`,"curtain",{top:`${~~(o/3)*128}px`,left:`${o%3*256}px`}),256,128,2)),N()}var Sn="id,name,kind,pos,scale,right,shape,colors,aspects,dream,type,material,recent,level,combat,hrz",$=1;function Rt(){$++}function tt(e){return e&&{...$t(e,Sn),chest:tt(e.chest),held:tt(e.held)}}function $t(e,t){return Object.fromEntries(t.split(",").map(n=>[n,e[n]]))}function nt(e){if(!e)return null;let t=y({...Ot[e.kind],...e,chest:nt(e.chest)});return e.held&&re(t,nt(e.held),e.held.pos),t}function It(){return{cur:l.id,lid:Ee,openRoom:$,rooms:C.map(e=>$t(e,"start,dream,aspects,level,stage,dur,drst")),all:Object.values(T).filter(e=>!e.parent&&e.kind!=4).map(e=>tt(e))}}function Bt(e){console.log(e),Object.values(T).forEach(t=>I(t)),e.all.forEach(t=>nt(t)),K(T[e.cur]),At(e.lid),$=e.openRoom,e.rooms.forEach((t,n)=>{Object.assign(C[n],t)}),N();for(let t of C)t.dream&&(t.toggleDream(!0),t.continueCombat())}var Me=class{constructor(t){this.id=t;this.stage=0;this.drst=0;this.dur=0;this.col=t%3,this.row=~~(t/3),this.l=256*this.col*2,this.t=128*this.row*2,this.pos=[t%3*256,0,128*~~(t/3+1)]}md(){y({...se,shape:80,material:"Obsidian",type:"Door",level:this.id,scale:2,pos:this.doorPos()})}drawTrees(t){let n=[null,["a9",1],["ba",2],["a9",3],["57",16],0,["a9",7,1],["mn",9],["mn",8,1]],o=[0,4,4,4,0,4],r=d(Back);for(let i=60;i>4;i--){let a=2*i**.7,s=c(A*.9)+.1;r.save(),r.translate(s,x-a-70);let m=30/(3+a*.6);r.scale(m,m),o[t]&&Se(Back,U("57",qe+o[t]),5,6),n[t]&&Se(Back,U(n[t][0],qe+n[t][1]),0,-8,n[t][2]??2),r.restore()}}draw(){let t=Ae[this.row],n=d(Back);if(Fe(this.id*99+(this.dream?this.stage+this.drst%1e3:0)),this.dream)if(this.stage%2){let i=S(Object.values(R)).colors,a=S(Object.values(R)).colors,s=v(L(i,c(5)+1));b(Back,s,[this.l,this.t,A,x]),b(t,v(L(a,c(3)+1)))}else{let i=c(8)+1,a=[0,["ba",9],["ba",9],["ba",9],["ba",9],["ij",9],["ij",13],["mn",14],["mn",14]][i],s=v(L(a[0],a[1]));n.save(),n.translate(this.l,this.t);let m=[["#00f","#f80"],["#88f","#00f"],["#008","#00f"]][c(3)],ee=n.createLinearGradient(0,0,0,100);m.forEach((ue,fe)=>ee.addColorStop(fe,ue)),n.fillStyle=ee,n.fillRect(0,0,A,x),n.fillStyle=s,n.fillRect(0,0+x*.6,A,x*.4+3),this.drawTrees(i),n.restore();let te=d(t);te.save(),te.translate(this.l,this.t),b(t,s,[0,0,A,x]);let pe=Dt(Ct("45",11),16);b(t,v(pe),[0,0,A,x],.5),te.restore()}else{let i=v(L("2f",c(3)+1));b(Back,i,[this.l,this.t,A,x]),b(t,v(L("rq",c(3)+1)))}let o=v(L("2g",1)),r=et[this.id];d(r).clearRect(0,0,A,x),this.open?(b(r,o,[0,0,10,x]),b(r,o,[0,x-10,A,10])):b(r,o,[0,0,A,x])}get open(){return this.id?this.id*1<=$:$>=13}removeEnemies(){this.chars(!0).forEach(t=>I(t))}toggleDream(t){this.dream=t,this.draw();for(let n of this.entities())k(n,[]),Pe(n,""),t||(n.combat={},n.dream&&I(n)),E(n),ie(n)}entities(t){return ae(t).filter(n=>j(P(n))==this)}chars(t){return this.entities(t).filter(n=>n.kind==1)}doorPos(){return f(this.pos,[256/2,1,0])}async wake(){this.blind(),await Ze(400),this.toggleDream(!1),this.stage=0}async sleep(t){this.blind(),await Ze(400),this.dur=0,this.drst=Date.now(),this.toggleDream(!0),this.aspects=t.aspects,this.level=t.level,this.nextEncounter()}nextEncounter(){for(let t=0;t<this.stage+1;t++)y({...De,level:1,colors:"nm",type:Nt(),name:vt(),chest:ke(ve+2,"lk"),pos:this.doorPos(),dream:!0});for(let t of[!0,!1]){let n=this.chars(t),o=f(this.pos,[(t?.3:.7)*256,0,0]);n.forEach((r,i)=>{r.pos=f(o,[0,((i+.5)/n.length*.7+.3)*64,0]),r.right=t,r.combat={pos:r.pos,hp:W(r),delay:Ce(r),aggro:0},ie(r),B(r)})}this.stage%2&&this.addItems(10,.2),this.continueCombat()}win(){this.stage++,this.entities(!0).forEach(t=>{t.kind==2&&Xt()?(t.dream=!1,E(t)):I(t)}),this.removeEnemies(),this.chars().forEach(t=>{t.combat.hp>0&&k(t,D(t,f(t.combat.pos,[-100,0,0])))}),this.blind(),this.chars()[0].actionsQueue.push(()=>this.nextEncounter())}living(){return this.chars().filter(t=>t.combat.hp>0)}continueCombat(){if(!this.dream)return;let t=this.living(),n=t.filter(s=>s.dream).length;if(n==0)return this.win();if(n==t.length)return this.wake();let o=Math.min(...t.map(s=>s.combat.delay)),r=t.find(s=>s.combat.delay==o),i=V([g(r,"S"),g(r,"M")])==1,a;i&&(a=Ne(t,s=>ot(r,s)?W(s)/s.combat.hp:0)),(!a||Yt(a))&&(i==!1,a=Ne(t,s=>ot(r,s)?0:.1*s.level+Math.max(0,g(s,"C")-g(s,"D")-g(r,"L"))+g(r,"A")*s.combat.aggro)),k(r,Ft(r,a,()=>t.forEach(s=>s.combat.delay-=o)))}blind(){let t=Ue(f(this.pos,[0,64,-128])),n=_("","blind",t);G(n,256,128,8),b(n,v(L("on",11))),setTimeout(()=>this.draw(),800),setTimeout(()=>Scene.removeChild(n),3900)}addItems(t,n=1){for(let o=0;o<t;o++){let r=Y(J,a=>a.chance),i=y({...He,type:r,pos:[this.col*256+10+c(256-20),c(64)*n,(this.row+1)*128]});i.aspects=wt(i.aspects,this.level+this.stage||10),i.level=Z(i.aspects),i.dream=this.dream,E(i)}}};function N(){C.forEach(e=>e.draw())}function j(e){return C[~~(e[0]/256)+3*~~(e[2]/128-1)]}function u(e){return j(P(e))||C[0]}function W(e){return~~((1+g(e,"H")+e.level*.5)*10)}function Ce(e){return~~(1e3/(1+g(e,"T")+e.level*.1+c()))}function wn(e){let t=u(e),n=1+t.dur/6e4;return e.dream?.7*n:1.3/n}function An(e,t){return~~((3+(g(e,"S")+e.level*.5)*c()*5-g(t,"R")*c())*wn(e))}function jt(e,t){let n=e.dream==t.dream;n||k(t,Zt(t));let o=!0;if(!n){let s=c()*(g(e,"L")*2+e.level)*2,m=c()*(g(t,"D")*2+t.level);o=s>m}let r=~~An(e,t)*(n?-1:1),i=Math.abs(r);o&&(t.combat.hp-=r,t.combat.hp=Math.min(Math.max(0,t.combat.hp),W(t)),e.combat.aggro+=i),Ve(o?`${i}`:"miss",rt(t),o?r>0?"red":"grn":""),ie(t);let a=u(t);t.combat.hp==0&&t.dream&&(a.chars(!1).forEach(s=>Ln(s,Cn(s,t))),Mn()&&(t.dream=!1,t.level=oe(t.level*.7),a.wake()))}function Ln(e,t){t&&(e.level+=t,Ve(`${t}xp`,rt(e),"#80f"))}function Mn(){return c()<.5/q().length**2*$}function Xt(){return c()<1/ae().filter(e=>e.kind==2&&!e.dream).length**2*$}function Cn(e,t){return Math.max(0,oe((5+t.level-e.level)/(1+e.level)/u(e).chars(!1).length*.05))}function Yt(e){return e.combat.hp==W(e)}function ot(e,t){return e.dream==t.dream}var kn="scaleX(-1) translateX(-100%)";var zt=1,Re=2,it=3;function Q(e,t,n){let o=e.pos,r=Date.now(),{stopDistance:i,mode:a}=n||{};a??=zt;let s=a==Re?.3:.1,m=he(e.pos,t)/s,ee=t[0]-e.pos[0];ee!=0&&a==zt&&(e.right=ee>0);let te=de(t,o);return()=>{let pe=Date.now(),ue=Math.min(pe-r,m);e.pos=f(o,te,m?ue/m:1);let fe=ue>=m||he(e.pos,t)<(i??0);return e.transform=fe?"":`rotateZ(${a==Re?-10:a==it?10:Math.sin(pe/100)*5}deg)`,!fe}}function Pn(e){return e.right?1:-1}function D(e,t,n=0){let o=u(e),r=j(t);if(r==null)debugger;return r==o?[()=>Q(e,t,{stopDistance:n})]:[()=>Q(e,o.doorPos()),()=>e.pos=f(r.doorPos(),[5,0,0]),()=>Q(e,t,{stopDistance:n})]}function st(e){let t=Date.now();return()=>Date.now()<t+e}function Zt(e){return[()=>Q(e,f(e.combat.pos,[Pn(e)*-20,0,0]),{mode:it}),()=>e.combat.hp?Q(e,e.combat.pos,{mode:it}):null]}function Ft(e,t,n=()=>{}){return[()=>Q(e,t.combat.pos,{mode:Re}),()=>{jt(e,t),n()},()=>Q(e,e.combat.pos,{mode:Re}),()=>{e.combat.delay=Ce(e),u(e).continueCombat()}]}function $e(e){return[e.size[0]*e.scale,e.size[1]*e.scale]}function B(e){!e||(Ie(e),E(e))}function E(e,t){if(!e)return;if(!e.animation&&e.actionsQueue){let a=e.actionsQueue.shift();if(a){let s=a();s instanceof Function&&(e.animation=s)}}e.animation&&e.animation()==!1&&delete e.animation;let n=e.div,o=t?f(e.pos,t):e.pos,r=de(o,Dn(e));n.style.opacity=e.opacity,n.classList.toggle("current",e==l),n.classList.add("k"+e.kind),n.classList.toggle("right",!!e.right),n.style.display=!e.dream&&u(e).dream&&e.kind!=1?"none":"block";let i=(e.right?kn:"")+(e.transform??"")+(e.combat?.hp==0?"rotateZ(90deg)translateX(8px)":"");Je(n,r,i),e.type=="Door"&&Pe(e,`<div class='foo'>Room ${u(e).id}</div>`)}function Dn(e){return[$e(e)[0]/2,0,$e(e)[1]]}function lt(e){let t=Qe(1),n=document.createElement("div");return n.classList.add("entity"),n.appendChild(t),n.style.position="absolute",t.id="s"+e.id,e.canvas=t,e.div=n,(e.kind==1||e.type=="Door")&&(e.title=document.createElement("div"),e.title.classList.add("etitle"),n.appendChild(e.title)),Ie(e),t}function Gt(e){return e&&[e.shape,e.colors]}function Ie(e){e.makeBits&&(e.bits=e.makeBits(e));let t=e.canvas,n=1;if(t.width=e.size[0]*n,t.height=e.size[1]*n,t.style.transformOrigin=e.origin,t.style.transform=`scale(${e.scale})`,d(t).imageSmoothingEnabled=!1,e.bits)for(let o=0;e.bits[o];o++){let r=e.bits[o];if(!r||!r[0])continue;let i=U(r[1],r[0]);d(t).drawImage(i,e.bitPos[o][0]*n,e.bitPos[o][1]*n,i.width*n,i.height*n)}}function Hn(e,t){e.material=t,e.colors=R[e.material]?.colors}function y(e){e.id??=Lt();let t={canvas:lt(e),floor:0,actionsQueue:[],...e},n=Tt[t.type];if(n&&(t.type??=n.name,n.placeh&&(t.mountPoint??=[5,0,9-n.placeh*8]),t.shape??=[0,16,80,0,0][t.kind]+n.ind,t.scale??=n.scale,t.material??=c(2)||!n.material?S(Object.keys(R)):n.material),t.colors=t.colors||R[t.material]?.colors,t.scale??=1,Ie(t),t.pos&&(T[e.id]=t,Scene.appendChild(t.div),e.className&&t.div.classList.add(e.className),E(t)),!t.aspects)for(let o of[R[t.material],ye[t.type],J[t.type]])t.aspects=xe(t.aspects,o?.aspects);return t}function I(e){e.div.parentElement?.removeChild(e.div),delete T[e.id]}function re(e,t,n){t.kind==2&&(t.parent&&ct(t.parent),e.div.appendChild(t.div),e.held=t,t.parent=e,t.pos=n??Et(e.mountPoint,e.scale),E(t))}function ct(e,t){let n=e.held;return delete e.held,n&&(n.pos=t??e.pos,Scene.appendChild(n.div),delete n.parent,B(n),B(e)),n}function ke(e,t){return{...O,shape:e,colors:t}}function Kt(e,t){t&&(e.colors=t.colors,e.shape=t.shape,e.scale=t.scale),Ie(e)}function P(e,t=!0){return t?Ut(le(e).pos):le(e).pos}function le(e){return e.parent?le(e.parent):e}function ce(e){return j(P(e)).dream}function mt(e,t){if(!t)return;let n=w[t];return y({...O,shape:Te+n.ind,colors:n.colors,pos:f(e.pos,[0,0,-30]),className:"thought",deadAt:Date.now()+3e3})}function pt(e){return e.level??Z(e.aspects)}function ut(e){if(e=="l"&&(e=Be),!e||e.kind==4)return;let t="",n="";if(e.kind==1?t=`${e.name} the ${e.type||"X"}`:t=`${e.material||""} ${e.type}`,at&&(n+=`<p><i>${e.tip||""} ${ze[e.type]??ze[e.kind]??""}</i></p>`),n+=`<h4>Level ${pt(e)}</h4>`,e.aspects&&(n+="<h5>Aspects</h5>"+St(e.aspects)),at&&(e.kind==1&&(n+="<p><i>Aspects represent this person's memories, personality and knowledge. Affects their performance while dreaming.</i></p>"),e.kind==2&&(n+=`<p><i>Characters can improve their aspects by looking at this item (happens automatically, but in the current room only). 
The chance of learning something scales with the person's level and item's level, and goes down with the amount of already learned tinhgs.</i></p>`),e.type=="Door")){let o="";e.material=="Obsidian"?o=`This door lets one person to escape (use RMB). But they need to have level >= ${u(e).id}. Doing it also unlocks new room. You first character can only use the door in room 0.`:o="This door no longer leads outside. But it allows moving between rooms (click on the destination to use the door automatically).",n+=`<p><i>${o}</i></p>`}return[t,n]}function Rn(e){let t=u(e).entities(),n=V(t.map(o=>{if(o==e||!_t(o))return 0;let r=he(e.pos,P(o));return pt(o)/(10+r)*Wt(e,o)}));return t[n]}function $n(e,t){let n=Y(t.aspects),o=pt(t)*Wt(e,t)*.01;o=oe(o),o&&(Ge(e.aspects,n,o),e.recent.unshift(t.id),e.recent.length=20,e==Be&&me(e),mt(t,n))}function Wt(e,t){e.recent??=[];let n=e.recent.indexOf(t.id);return n==-1&&(n=1e6),1-1/(1+n)}function qt(e){if(!In(e))return;let t=Rn(e);!t||k(e,[...D(e,P(t),10),()=>$n(e,t),()=>st(1e3)])}function In(e){return!e.actionsQueue?.length&&!e.animation}function Qt(e){let t=Z(e.aspects),n=Y(ft);(q().length+3)*Z(e.aspects)/(e.level+3)>c(100)&&(e.aspects[n]=Math.max(0,e.aspects[n]-.01*~~(t-e.level+1)))}function Vt(e){return u(e).dream}function k(e,t){!e||(e.actionsQueue=t,delete e.animation)}function g(e,t){return e.aspects[t]??0}function Pe(e,t){e.title&&(e.title.innerHTML=t)}function ie(e){Pe(e,e.combat?.hp>=0?`${e.combat?.hp}/${W(e)} hp`:"")}function Nt(){return Y(ye,e=>e.chance)}function Jt(e,t){if(t.type=="Door"){let o=u(t).id;if(t.material=="Obsidian"){if(e.level<o){alert(`Need level ${o} to use`);return}if(e.tip=="This is you."){alert("You can't use this door. Maybe you can find someone else who can?");return}Hn(t,"Wooden"),B(t),I(e),K(q()[0]),Rt(),N(),alert(`Walking through this door, they have left these rooms for good. 
Have they went to the real world, or just disappeared? Who knows.
Also, new room has opened.`)}return}let n=e.held;if(n?.type=="Brush"){t.colors=n.colors,B(t);return}t.type=="Bed"&&u(e).sleep(e)}function q(){return ae(!1).filter(e=>e.kind==1)}function ae(e){return Object.values(T).filter(t=>e===void 0||!t.dream==!e)}function rt(e){return f(e.pos,[-5+c(10),0,-35])}var dt=[],Oe=[-380,20],tn=600;function Ut(e){return[e[0],e[1],Math.ceil(e[2]/128)*128]}function en(e,t){Kt(X,e),X.pos=t,Scene.appendChild(X.div),E(X)}function ht(){Scene.style.left=`${Oe[0]}px`,Scene.style.top=`${Oe[1]}px`}function nn(){onpointerup=e=>{dt[e.button]=!1},onpointerdown=e=>{dt[e.button]=!0;let[t,n,o,r]=Xe(e),i=[t,n,(r+1)*128],a;if(l&&o=="f"&&!e.shiftKey&&(j(i)?.dream&&j(i).wake(),(e.button==2||e.button==0&&!l.held)&&(a=D(l,i)),e.button==0&&l.held&&(a=[...D(l,i),()=>ct(l)])),l&&o=="s"&&!e.shiftKey){let m=T[r];if(m&&m!=l){if(ce(m)){u(m).wake();return}e.button==2&&(a=[...D(l,P(m),15),()=>Jt(l,m)]),e.button==0&&(m.kind==1?K(le(m)):a=[...D(l,P(m)),()=>{l.held?m.held||re(m,l.held):re(l,m)}])}}a&&!ce(l)&&k(l,[...a,()=>st(5e3)]),oncontextmenu=m=>{m.shiftKey||m.preventDefault()},e.target.classList.contains("sprite")},onmousemove=e=>{if(dt[1]){let m=.5;Oe=f(Oe,[e.movementX,e.movementY],m),ht()}let[t,n,o,r]=Xe(e),i=[t,n,(r+1)*128],a=l?.held,s=T[r];if(me(s),a&&(o=="f"&&en(a,i),o=="s"&&s&&s.kind==2)){let m=f(s.pos,[0,0,-$e(s)[1]*.7]);en(a,m),s.div.parentElement?.appendChild(X.div)}e.preventDefault()},onwheel=e=>{tn-=e.deltaY*.2,bt()}}var Be;function _t(e){return e.kind==2||e.kind==1}var at=!0;function me(e){let t=ut(e)||ut(l);Be=e||l,Info.innerHTML=t?`<h1>${t[0]}</h1>${t[1]}`:""}function bt(){Scene.style.transform=`translateZ(${tn}px)`}function Xe(e){let[t,n,o]=[e.target.id,e.offsetX,e.offsetY],r=t[0],i=1*t.substring(1);return[n,o,r,i]}function yt(e){return[...e.matchAll(/(\w)(\w)(\w)/g)].map(t=>[...t.slice(1,4).map(n=>~~(Number.parseInt(n,36)/36*100)/100),1])}var on="906j05u58zdczpdrfag867240125869i8lp8zu7zi8t94h34724i97wlfzuozzvqrrfjj68a13509d4kngtqzvuzjnq8kd3duzzxxx";var ln=1,cn=2,mn=0;addEventListener("pointerdown",e=>{let[t,n,o,r]=Xe(e);if(o=="f"&&e.button==0&&e.shiftKey){let a=sn();a.pos=[t,n,r*128],E(a)}o=="O"&&(mn=r),o=="C"&&(e.button==0?ln=r:cn=r),Preview.innerHTML="";let i=sn();Preview.appendChild(i.canvas)});var rn="ayhiadream",an=0;addEventListener("keydown",e=>{if(e.code=="KeyD"&&Debug.classList.toggle("dn"),e.code=="KeyS"){let t=It();console.log(t),localStorage.setItem(rn,JSON.stringify(t))}if(e.code=="KeyL"){let t=localStorage.getItem(rn);t&&Bt(JSON.parse(t))}if(e.code=="KeyT"){let t=u(l).entities(),n=S(t);k(l,D(l,P(n),15))}if(e.code=="KeyE"){let t=Object.keys(w)[an];mt(l,t),an++}e.code=="KeyN"&&(ce(l)?u(l).wake():u(l).sleep(l))});function sn(){return y({...O,shape:mn,colors:ln+""+cn,pos:[0,0,0]})}var De={bitPos:[[3,1],[2,14],[2,10],[2,13]],mountPoint:[0,0,16],size:[16,24],origin:"75% 50%",kind:1,makeBits:e=>[[e.shape,e.colors],[kt,e.colors],Gt(e.chest),[Pt,e.colors]]},se={bitPos:[[0,0]],size:[10,10],kind:3,makeBits:e=>e&&[[e.shape,e.colors]]},He={...se,kind:2},O={...se,kind:4},Ot=[,De,He,se,O],be=yt(on),Ke=new Set,Ai,pn,Li,X,fn,l,T={};onload=()=>{e:console.log(123);img.onload=Bn,img.src="16cols.gif"};function K(e){let t=l;l=e,B(t),l&&(B(l),l.div.appendChild(fn.div))}var C=[];function Bn(){C=H(15,e=>new Me(e)),Ht(),C.forEach(e=>e.md()),bt(),nn(),ht(),pn=y({...De,level:1,shape:18,colors:"nm",type:"Cat",name:"Miu",chest:ke(ve+2,"lk"),pos:[320,10,128],tip:"This is you."}),y({...He,type:"Bed",material:"Wooden",pos:[384,32,128]}),X=y({...O,opacity:.5,shape:1,colors:"ab",pos:[0,0,0],noclick:!0}),X.canvas.classList.add("phantom"),fn=y({...O,shape:8,colors:"ab",pos:[8,0,4],className:"pointer"}),K(pn),N(),dn(0),me()}var un=0,gt=0,xt=0,ft;function On(){q().forEach(Qt)}function dn(e){let t=Math.min(1e3,e-un||1);ft=q().reduce((o,r)=>xe(o,r.aspects),{}),~~((xt+t)/1e3)>~~(xt/1e3)&&On(),xt+=t,un=e;let n=Date.now();gt=gt*.9+1e3/t*.1,FPS.innerText=`FPS: ${~~gt}`,Object.values(T).forEach(o=>{(o.actionsQueue.length||o.animation)&&E(o),o.deadAt&&n>o.deadAt&&I(o),o.kind==1&&!Vt(o)&&t>c()*3e3&&qt(o),document.querySelectorAll(".aspect").forEach(r=>{let i=w[r?.dataset?.aspect];if(!i)return;delete r?.dataset?.aspect;let a=lt({...O,shape:Te+i.ind,colors:i.colors});r.prepend(a)})}),C.forEach(o=>{o.dur&&(o.dur+=t)}),requestAnimationFrame(dn),l?.held||(X.div.style.opacity="0")}})();
//# sourceMappingURL=bundle.js.map
