(()=>{function f(e,t,n=1){return e.map((o,r)=>o+t[r]*n)}function kt(e,t=1){return e.map((n,o)=>n*t)}function Me(e,t){return f(e,t,-1)}function Sn(e){return e.reduce((t,n)=>t+n*n,0)**.5}function Ae(e,t){return Sn(Me(t,e))}var Ge=2**31,c=Ke(123);function Ke(e=0){0<e&&e<1&&(e=~~(e*Ge));let t=n=>(e=e*16807%2147483647)%n;return c=n=>n==-1?e:n==null?t(Ge)/Ge:t(n),c}function le(e,t=c){if(!e)return null;let n=t(e.length);return e[n]}function pe(e,t=c){let n=qe(e),o=t()*n-e[0],r=0;for(;o>=0;)o-=e[++r];return r}function We(e,t,n=c){let o=e.map(t),r=pe(o);return e[r]}function M(e,t=o=>o,n=c){let o=pe(Object.values(e).map(t),n);return Object.keys(e)[o]}function qe(e){return e.reduce((t,n)=>t- -n,0)}function Lt(e=c){let t="";for(let n=0;n<e(3)+2;n++)t+=le([..."kstnhmyrw",""],e)+le([..."aiueo",""],e);return wn(t)}function wn(e){return e?e[0].toUpperCase()+e.substring(1):""}function ye(e){for(let t of Object.values(e))for(let n in t){let o=Number(t[n]);!isNaN(o)&&n!="colors"&&(t[n]=o)}return e}function V(e,t=.01){return e/=t,e=(e-Math.floor(e)>c()?1:0)+Math.floor(e),e*=t}function C(e,t=n=>n){return[...new Array(~~Math.max(e,0))].map((n,o)=>t(o))}var Qe=e=>new Promise(t=>setTimeout(t,e)),S=e=>e&&e.toFixed(2).replace(/(.00)/g,"");function J(e){Msg.innerHTML=`<p>${e}</p><p><button onclick="Msg.style.display='none'">OK</button></p>`,Msg.style.display="block"}var v=ye(Object.fromEntries(`Health:So called Hit Points:31
Strength:Dealing Damage:fg
Resilience:Damage reduction:qp
Greed:Find More:c4
Bloom:Regeneration:ba
Courage:Cover your allies:21
Anger:Avenge Damage:uv
Mercy:Heal Friends:lx
Knowledge:Reading and writing Tomes:mn
Light:Strike True:je
Dark:Evade:o8
Time:Action Rate:lm
Purity:Resist Poison:rq
Venom:Poison foe:ba`.split(`
`).map((e,t)=>{let[n,o,r]=e.split(":"),i=n[0];return[i,{l:i,name:n,tip:o,colors:r,ind:t}]}))),z=ye(Object.fromEntries(`Wooden:67:H:10
Iron:lm:S:10
Stone:mn:R:10
Golden:c4:G:2
Plant:ba:B:5
Leather:56:C:5
Bone:ji:A:5
Cloth:tv:M:10
Paper:kl:K:5
Glass:wr:L:5
Obsidian:no:D:2
Copper:ef:T:5
Silver:lx:PM:3
Asbestos:kb:V:1
Abstract:::1`.split(`
`).map(e=>{let[t,n,o,r]=e.split(":");return[t,{colors:n,aspects:Le(o),chance:r}]})));var U=ye(Object.fromEntries(`Door:2::Wooden:0:1:
Bed:2:H:Wooden:20:.5:
Column:3:R:Stone:0:1:
Apple:1:B:Plant:10:1:
Chair:1.5:H:Wooden:5:1:
Chest:1:G:Wooden:10:1:
Shelf:2:G:Wooden:3:1:
Stand:2:S:Stone:2:1:base
Display:2::Glass:3:1:
Plaque:2:R:Iron:2:1:base
Big Table:2:R:Stone:2:1:base
Display:2::Glass:2:1:base
Trinket:1::Glass:20:1:
Table:2::Wooden:2:.5:base
Clock:1:T:Golden:10:1:
Pedestal:1.5::Wooden:2:1:base
Mirror:2::Glass:5:1:
Angel:1:P:Silver:10:1:
Press:2::Iron:0:1:
Brush:1:::5:1:
Wine:1:A:Plant:5:1:
Extractor:1:::5:1:
Essense:1:::5:1:
Shirt:1:T:Cloth:10:1:armor
Robe:1:M:Paper:10:1:armor
Chain:1:S:Iron:10:1:armor
Plate:1:R:Iron:10:1:armor
Sword:1:S:Iron:10:1:
Axe:1:T:Iron:10:1:
Hammer:1:S:Stone:2:1:
Spear:1:R:Wooden:10:1:
Wand:1:M:Silver:10:1:
Shrinker:1:D::2:1:
Magnifier:1:L::2:1:
Tome:1:::10:1:
Cactus:1:V::5:1:
Chalice:1:C::10:1:`.split(`
`).map((e,t)=>{let[n,o,r,i,a,s,l]=e.split(":");return[n,{use:l,type:n,scale:o,aspects:Le(r),material:i,chance:a??0,ind:t,placeh:s}]}))),ke=ye(Object.fromEntries(`Human:G
Elf:B
Cat:D
Ogre:H
Fairy:M
Bird:L
Rat:D
Raven:A
Skel:C
Imp:V
Dog:S
Hippo:H
Lizard:B
Drago:P
Alien:K
Hare:T`.split(`
`).map((e,t)=>{let[n,o]=e.split(":");return[n,{name:n,aspects:Le(o),ind:t,chance:1/(10+t)}]}))),Ct={...ke,...U},be={2:"An item that you have found in the dream. Looking at it (happens automatically when awake) can help to remember something about reality (i.e. raise aspects).",Bed:"RMB to sleep. Level up and find items in dreams. What you find in the dream is affected by the room number and the aspects of the bed and the dreamer. RMB to wake.",Brush:"Can recolor items.",Clock:"Put on the bed to sleep automatically.",Hammer:"For the deep analysis (RMB with it in hand on some disposable item).",Extractor:"Extract essense from the item. User's, extractor's and item's aspects should match for best results.",Tome:"Hold to write in",armor:"RMB to wear",base:"Can't be examined by itself, gives bonuses to items on it."},Ht=[["#00f","#f80"],["#88f","#00f"],["#008","#00f"]];function Le(e=""){let t={};return[...e].forEach(n=>t[n]=(t[n]||0)+1),t}function X(e,t,n=1){let o={};e??={},t??={};for(let r in{...e,...t})o[r]=(e[r]||0)+(t[r]||0)*n;return o}function Pt(e,t){let n={};e??={},t??={};for(let o in{...e,...t})n[o]=(e[o]||0)*(t[o]||0);return n}function $t(e,t){let n="";for(let o of Object.keys(v)){let r=e[o]||0,i=t?m(t,o):r;i&&(n+=`<div class="aspect" data-aspect=${o}></div>
      <div class=num>${S(r)} ${i!=r?`<i>/${S(i)}</i>`:""}</div>
      <div> ${v[o].name}</div><div> <i>${v[o].tip}</i></div>`)}return`<p><div class=stats>${n}</div></p>`}function H(e){return qe(Object.values(e))}function Ce(e,t,n){e[t]=(e[t]||0)+n}function ce(e,t,n=1){let o=H(e),r={...e};for(let i=o;i<t;i+=n)c(Object.keys(e).length+1)?Ce(r,M(r),n):(Ce(r,M(r),1),i+=1);return r}function Je(e,t){return{[M(e)]:t*H(e)}}var _="ayhiadream";var He=0;function Dt(e){He=e}function Rt(){return++He}var w=256*2,P=128*2,xe=64*2-1,_e=(e,t,n)=>Mn(Ln(n,e),t),$=(e,t)=>_e("S",e,t),Ot=(e,t)=>_e("T",e,t),te=(e,t)=>_e("O",e,t);function Mn(e,t){if(!e)debugger;if(!t)return e;let n=e.cloneNode();return b(n).filter=Cn(t),b(n).drawImage(e,0,0),n}var Bt=16;var An=48,kn=56,Pe=64,et=112;var $e=144,Xt=kn,Yt=An,It=16;function Ln(e,t,n=0){t=="O"&&(n=1);let o=tt(8+n*2);return o.id=t+e,b(o).filter=`url(#_${t})`,b(o).drawImage(img,e%It*8,~~(e/It)*8,8,8,n,n,8,8),o}function b(e){return e.getContext("2d")}function Cn(e){if(!Ue.has(e)){Ue.add(e);let[t,n]=[...e].map(r=>Ve[Number.parseInt(r,36)]),o=`<filter id=f${e}><feColorMatrix type=matrix values="${t[0]} ${n[0]} 0 0 0  ${t[1]} ${n[1]} 0 0 0  ${t[2]} ${n[2]} 0 0 0  0 0 0 1 0" /></filter>`;DEFS.innerHTML+=o}return`url(#f${e})`}function tt(e,t=e){let n=document.createElement("canvas");return n.classList.add("sprite"),n.width=e,n.height=t,n}var A=e=>b(e).createPattern(e,"repeat");function nt(e,t,n){let o=document.createElement("div");o.classList.add("ftext"),n&&o.classList.add(n),o.innerHTML=`<div>${e}</div>`,Scene.appendChild(o),setTimeout(()=>Scene.removeChild(o),3e3),ot(o,t)}function ot(e,t,n=""){Object.assign(e.style,rt(t,n))}function rt(e,t=""){return{left:`${e[0]}px`,top:`${e[2]}px`,transform:`translateZ(${e[1]}px) `+t}}function E(e,t,n,o=1){let r=b(e);o&&(r.globalAlpha=o),r.fillStyle=t,r.fillRect(...n||[0,0,e.width,e.height]),o&&(r.globalAlpha=1)}function ne(e,t,n,o=1){return e.width=t*o,e.height=n*o,e.style.width=`${t}px`,e.style.height=`${n}px`,e}function me(e,t,n,o="canvas"){let r=document.createElement(o);return r.id=e,r.classList.add(...t.split(",")),Object.assign(r.style,n),Scene.appendChild(r),r}function Ft(e,t){let n=e.cloneNode();return n.width*=t,n.height*=t,de(n,e,0,0,t),n}function de(e,t,n,o,r=1){b(e).imageSmoothingEnabled=!1,b(e).drawImage(t,n,o,t.width*r,t.height*r)}var Hn,Re,st;function jt(){let e="";Scene.innerHTML+=e,ne(Back,256*3,128*5,2);let t=A($("gf",2));Hn=C(3+1,o=>{let r=me(`w${o}`,"wall",{left:`${o*256}px`});return ne(r,64,128*5,2),E(r,t),r}),Re=C(5+1,o=>ne(me(`f${o-1}`,"floor",{top:`${o*128}px`}),256*3,64,2));let n=Re.shift();E(n,A($("87",2))),n.style.pointerEvents="none",st=C(15,o=>ne(me(`c${o}`,"curtain",{top:`${~~(o/3)*128}px`,left:`${o%3*256}px`}),256,128,2)),G()}var Pn="id,name,kind,pos,scale,right,shape,colors,aspects,dream,type,material,recent,level,combat,hrz,sleeper,log",fe=1,oe=[-380,20];function Nt(){fe++}function lt(e){return e&&{...Zt(e,Pn),chest:lt(e.chest),held:lt(e.held)}}function Zt(e,t){return Object.fromEntries(t.split(",").map(n=>[n,e[n]]))}function pt(e){if(!e)return null;let t=y({...zt[e.kind],...e,chest:pt(e.chest)});return e.held&&K(t,pt(e.held),e.held.pos),t}function $n(){return{cur:p?.id,lid:He,sp:oe,openRoom:fe,date:Date.now(),rooms:k.map(e=>Zt(e,"start,dream,aspects,level,stage,dur,drst")),all:Object.values(x).filter(e=>!e.parent&&e.kind!=4).map(e=>lt(e))}}function Dn(e){Object.values(x).forEach(t=>T(t)),e.all.forEach(t=>pt(t)),R(x[e.cur]),Dt(e.lid),e.sp&&(oe=e.sp),fe=e.openRoom,e.rooms.forEach((t,n)=>{Object.assign(k[n],t)}),G();for(let t of k)t.dream&&(t.tdr(!0),t.fight());ge()}var at=!0;function ue(e){if(at=e===void 0?!at:e,Saves.innerHTML="Press ESC to toggle menu",!at){Msg.style.display="none";return}let t=JSON.parse(localStorage.getItem(_)||"[]");Saves.innerHTML+=`<div class=saves>${C(10,n=>`<div>
    ${n||"auto"}</div><button onclick="save(${n})">Save</button>
 ${t[n]?`<button onclick="load(${n})">Load</button><div>${new Date(t[n].date).toUTCString()}</div>`:"<div></div><div></div>"}`).join("")} 
 </div>`}window.save=e=>{let t=JSON.parse(localStorage[_]||"[]");t[e]=$n(),localStorage[_]=JSON.stringify(t),ue(!1)};window.load=e=>{let t=JSON.parse(localStorage[_]||"[]");Dn(t[e]),ue(!1)};var Oe=class{constructor(t){this.id=t;this.stage=0;this.drst=0;this.dur=0;this.col=t%3,this.row=~~(t/3),this.l=256*this.col*2,this.t=128*this.row*2,this.pos=[t%3*256,0,128*~~(t/3+1)]}md(){y({...Se,shape:Pe,material:"Obsidian",type:"Door",level:this.id,scale:2,pos:this.doorPos()})}drawTrees(t){let n=[null,["a9",1],["ba",2],["a9",3],["57",16],0,["a9",7,1],["mn",9],["mn",8,1]],o=[0,4,4,4,0,4],r=b(Back);for(let i=60;i>4;i--){let a=2*i**.7,s=c(w*.9)+.1;r.save(),r.translate(s,P-a-70);let l=30/(3+a*.6);r.scale(l,l),o[t]&&de(Back,te("57",et+o[t]),5,6),n[t]&&de(Back,te(n[t][0],et+n[t][1]),0,-8,n[t][2]??2),r.restore()}}draw(){let t=Re[this.row],n=b(Back);Ke(this.id*99+(this.dream?this.stage+this.drst%1e3:0)),n.save(),n.translate(this.l,this.t);let o=b(t);if(o.save(),o.translate(this.l,0),this.dream){let a=n.createLinearGradient(0,0,0,100);if(Ht[c(3)].forEach((s,l)=>a.addColorStop(l,s)),n.fillStyle=a,n.fillRect(0,0,w,P),this.stage%2){let s=le(Object.values(z)).colors,l=le(Object.values(z)).colors,L=A($(s,c(5)+1));E(Back,L,[0,0,w,P]),E(t,A($(l,c(3)+1)),[0,0,w,xe]),C(3,B=>{de(Back,te("rf",118),256/2*(1+B)-16,128*.7,4),o.globalAlpha=.2,de(t,te("kk",123),256/2*(1+B)-16,64*.7,4)})}else{let s=c(8)+1,l=[0,["ba",9],["ba",9],["ba",9],["ba",9],["ij",9],["ij",13],["mn",14],["mn",14]][s],L=A($(l[0],l[1]));n.fillStyle=L,n.fillRect(0,0+P*.6,w,P*.4+3),this.drawTrees(s),E(t,L,[0,0,w,xe]);let B=Ft(Ot("45",11),16);E(t,A(B),[0,0,w,xe],.5)}}else E(Back,A($("2f",c(3)+1)),[0,0,w,P]),E(t,A($("rq",c(3)+1)),[0,0,w,xe]);o.restore(),n.restore();let r=A($("2g",1)),i=st[this.id];b(i).clearRect(0,0,w,P),this.open?(E(i,r,[0,0,10,P]),E(i,r,[0,P-10,w,10])):E(i,r,[0,0,w,P])}get open(){return this.id?this.id*1<=fe:fe>=13}tdr(t){this.dream=t,this.draw();for(let n of this.entities())Y(n,[]),Be(n,""),n.dream=!!n.dream,t||(n.combat={},n.dream&&T(n)),O(n),Ee(n)}entities(t){return Te(t).filter(n=>W(j(n))==this)}chars(t){return this.entities(t).filter(n=>n.kind==1)}doorPos(){return f(this.pos,[256/2,1,0])}center(){return f(this.pos,[256/2,64/2,0])}async wake(){if(!p||p.dream&&h(p)==this){let t=this.chars(!1),n=t.find(o=>o.sleeper)||t[0];R(n)}this.blind(),await Qe(500),this.tdr(!1),this.stage=0,window.save(0)}greed(){return 1+.1*Math.max(...this.chars(!1).map(t=>m(t,"G")))}async sleep(t,n){this.chars().forEach(a=>a.sleeper=0),t.sleeper=1,this.blind(),await Qe(400),this.dur=0,this.drst=Date.now(),this.tdr(!0);let o=X(t.aspects,n.aspects),r=H(o);o=X(o,{[Object.keys(v)[this.id]]:1});let i=Math.max(1,r-3);this.aspects=ce(o,i),this.level=i,this.next()}next(){for(let t=0;t<~~(this.stage/4)+1;t++)y({...Xe,levelTo:this.level,type:Qt(),name:Lt(),chest:y({...F,levelTo:this.level,type:le(Object.keys(U).filter(n=>U[n].use=="armor"))}),pos:this.doorPos(),addAspects:Je(this.aspects,.2),dream:!0});for(let t of[!0,!1]){let n=this.chars(t),o=f(this.pos,[(t?.3:.7)*256,0,0]);n.forEach((r,i)=>{r.pos=f(o,[0,((i+.5)/n.length*.7+.3)*64,0]),r.right=t,r.combat={pos:r.pos,hp:re(r),delay:ve(r),aggro:0,poison:0},Ee(r),g(r)})}this.stage%2&&this.addItems(10,.2),this.fight()}win(){this.stage++,this.entities(!0).forEach(t=>{t.kind==2&&Gt(this)?(t.dream=!1,O(t)):T(t)}),this.chars(!0).forEach(t=>T(t)),this.chars().forEach(t=>{t.combat.hp>0&&Y(t,q(t,f(t.combat.pos,[-100,0,0])))}),this.blind(),this.chars()[0].actionsQueue.push(()=>this.next())}living(){return this.chars().filter(t=>t.combat.hp>0)}fight(){if(!this.dream)return;let t=this.living(),n=t.filter(l=>l.dream).length;if(n==0)return this.win();if(n==t.length)return this.wake();let o=Math.min(...t.map(l=>l.combat.delay)),r=t.find(l=>l.combat.delay==o),i=qt(r)*ve(r)/1e3;i&&mt(r,i);let a=pe([m(r,"S")+r.level*.1,m(r,"M")/3])==1,s;a&&(s=We(t,l=>ct(r,l)?re(l)/l.combat.hp:0)),(!s||Kt(s))&&(a==!1,s=We(t,l=>ct(r,l)?0:.1*l.level+Math.max(0,m(l,"C")-m(l,"D")-m(r,"L"))+m(r,"A")*l.combat.aggro)),Y(r,Wt(r,s,()=>t.forEach(l=>l.combat.delay-=o)))}blind(){let t=rt(f(this.pos,[0,64,-128])),n=me("","blind",t);ne(n,256,128,8),E(n,A($("on",11))),setTimeout(()=>this.draw(),800),setTimeout(()=>Scene.removeChild(n),3900)}addItems(t,n=1){for(let o=0;o<t;o++){let r=M(U,a=>a.chance),i=y({...F,type:r,addAspects:this.aspects?Je(this.aspects,.2):void 0,levelTo:(this.level+this.stage)*(r=="Tome"?.2:1),pos:[this.col*256+10+c(256-20),c(64-5)*n+5,(this.row+1)*128]});i.level=~~(this.level+this.stage),i.dream=this.dream,O(i)}}};function G(){k.forEach(e=>e.draw())}function W(e){return k[~~(e[0]/256)+3*~~(e[2]/128-1)]}function h(e){return W(j(e))||k[0]}function re(e){return~~((1+m(e,"H")+e.level*.5)*10)}function ve(e){return~~(1e3/(1+m(e,"T")+e.level*.1+c()))}function Rn(e){let t=h(e),n=1+t.dur/6e4;return e.dream?.5*n:1.5/n}function In(e,t){return Math.max(0,3+(m(e,"S")+e.level*.5)*3-m(t,"R")/2)*Rn(e)}function Vt(e,t){let n=e.dream==t.dream;n||Y(t,Jt(t));let o=In(e,t),r=!0;if(!n){let a=c()*(m(e,"L")*2+e.level)*2,s=c()*(m(t,"D")*2+t.level);r=a>s}let i=n?~~(1+m(e,"M")):-~~((c()+.5)*o);mt(t,i,r,e,n||!r?0:V(m(e,"V")/(1+m(t,"P"))*.3,1))}function mt(e,t,n=!0,o,r=0){if(t=V(t,1),!t&&!r)return;let i=Math.abs(t);if(n&&(e.combat.hp+=t,e.combat.hp=Math.min(Math.max(0,e.combat.hp),re(e)),o&&(o.combat.aggro+=i)),t>0&&o&&o.dream!=e.dream)debugger;if(t<0&&o&&o?.dream==e.dream)debugger;let a=n?`${(t>0?"+":"")+S(t)}`:"miss",s=n?t<0?"red":"grn":"";nt(a,dt(e),s);let l=`<div>${o?Ye(o):t<0?"poison":"regen"} 
  <span class=${s}>${a}</span> ${r?S(r)+" poison":""} ${Ye(e)}</div>`;e.combat.poison+=r,o&&ie(o,l),ie(e,l),Ee(e);let L=h(e);e.combat.hp==0&&e.dream&&(L.chars(!1).forEach(B=>On(B,Xn(B,e))),Bn(L)&&(e.dream=!1,e.level=V(e.level*.7),e.aspects=ce(e.aspects,e.level),L.wake()))}function ie(e,t){e.log=e.log.slice(0).slice(-5)??[],e.log.push(`<div>${t}</div>`),he==e&&N(e)}function On(e,t){t&&(e.level+=t,nt(`${t}xp`,dt(e),"#80f"))}function Bn(e){let t=se().length;return t==1||c()<.2/t*e.greed()}function Gt(e){let t=7/(10+Te().filter(n=>n.kind==2&&!n.dream).length)*e.greed();return c()<t}function Xn(e,t){return Math.max(0,V((5+t.level-e.level)/(1+e.level)/h(e).chars(!1).length*.1))}function Kt(e){return e.combat.hp==re(e)}function ct(e,t){return e.dream==t.dream}var Yn="scaleX(-1) translateX(-100%)";var Ut=1,Fe=2,ft=3;function ae(e,t,n){let o=e.pos,r=Date.now(),{stopDistance:i,mode:a}=n||{};a??=Ut;let s=a==Fe?.3:.1,l=Ae(e.pos,t)/s,L=t[0]-e.pos[0];L!=0&&a==Ut&&(e.right=L>0);let B=Me(t,o);return()=>{let wt=Date.now(),Mt=Math.min(wt-r,l);e.pos=f(o,B,l?Mt/l:1);let At=Mt>=l||Ae(e.pos,t)<(i??0);return e.transform=At?"":`rotateZ(${a==Fe?-10:a==ft?10:Math.sin(wt/100)*5}deg)`,!At}}function Fn(e){return e.right?1:-1}function q(e,t,n=0){let o=h(e),r=W(t);if(r==null)debugger;return r==o?[()=>ae(e,t,{stopDistance:n})]:[()=>ae(e,o.doorPos()),()=>e.pos=f(r.doorPos(),[5,0,0]),()=>ae(e,t,{stopDistance:n})]}function ht(e){let t=Date.now();return()=>Date.now()<t+e}function Jt(e){return[()=>ae(e,f(e.combat.pos,[Fn(e)*-20,0,0]),{mode:ft}),()=>e.combat.hp?ae(e,e.combat.pos,{mode:ft}):null]}function Wt(e,t,n=()=>{}){return[()=>ae(e,e==t?f(t.combat.pos,[0,0,-10]):t.combat.pos,{mode:Fe}),()=>{Vt(e,t),n()},()=>ae(e,e.combat.pos,{mode:Fe}),()=>{e.combat.delay=ve(e),h(e).fight()}]}function qt(e){return m(e,"B")-e.combat.poison}function je(e){return[e.size[0]*e.scale,e.size[1]*e.scale]}function g(e){!e||(Ze(e),O(e))}function O(e,t){if(!e)return;if(!e.animation&&e.actionsQueue){let a=e.actionsQueue.shift();if(a){let s=a();s instanceof Function&&(e.animation=s)}}delete e.aspects?.undefined,e.animation&&e.animation()==!1&&delete e.animation;let n=e.div,o=t?f(e.pos,t):e.pos,r=Me(o,jn(e));n.style.opacity=e.opacity,n.classList.toggle("current",e==p),n.classList.add("k"+e.kind),n.classList.toggle("right",!!e.right),n.style.display=!e.dream&&h(e).dream&&e.kind!=1&&!e.parent?"none":"block";let i=(e.right?Yn:"")+(e.transform??"")+(e.combat?.hp==0?"rotateZ(90deg)translateX(8px)":"");ot(n,r,i),e.type=="Door"&&Be(e,`<div class='roomn'>Room ${h(e).id}</div>`)}function jn(e){return[je(e)[0]/2,0,je(e)[1]]}function yt(e){let t=tt(1),n=document.createElement("div");return n.classList.add("entity"),n.appendChild(t),n.style.position="absolute",t.id="s"+e.id,e.canvas=t,e.div=n,(e.kind==1||e.type=="Door")&&(e.title=document.createElement("div"),e.title.classList.add("etitle"),n.appendChild(e.title)),Ze(e),t}function _t(e){return e&&[e.shape,e.colors]}function Ze(e){e.makeBits&&(e.bits=e.makeBits(e));let t=e.canvas,n=1;if(t.width=e.size[0]*n,t.height=e.size[1]*n,t.style.transformOrigin=e.origin,t.style.transform=`scale(${e.scale})`,b(t).imageSmoothingEnabled=!1,e.bits)for(let o=0;e.bits[o];o++){let r=e.bits[o];if(!r||!r[0])continue;let i=te(r[1],r[0]);b(t).drawImage(i,e.bitPos[o][0]*n,e.bitPos[o][1]*n,i.width*n,i.height*n)}}function Nn(e,t){e.material=t,e.colors=z[e.material]?.colors}function y(e){e.id??=Rt();let t={canvas:yt(e),floor:0,actionsQueue:[],...e},n=Ct[t.type];if(n&&(t.type??=n.type,n.placeh&&(t.mountPoint??=[5,0,9-n.placeh*8]),t.shape??=[0,Bt,Pe,0,0][t.kind]+n.ind,t.scale??=n.scale,t.use??=n.use,t.material??=c(2)||!n.material?Kn():n.material),t.colors=t.colors||z[t.material]?.colors,t.scale??=1,t.log=[],Ze(t),t.pos&&(e.className&&t.div.classList.add(e.className),en(t)),!t.aspects)for(let o of[z[t.material],ke[t.type],U[t.type]])t.aspects=X(t.aspects,o?.aspects);return e.addAspects&&(t.aspects=X(t.aspects,e.addAspects)),e.levelTo&&(t.aspects=ce(t.aspects,e.levelTo)),t.level??=H(t.aspects),t}function en(e){x[e.id]||(x[e.id]=e,Scene.appendChild(e.div),g(e))}function T(e){e.div.parentElement?.removeChild(e.div),delete x[e.id]}function K(e,t,n){t.kind==2&&(t.parent&&ze(t.parent),e.div.appendChild(t.div),e.held=t,t.parent=e,t.pos=n??kt(e.mountPoint,e.scale),O(t))}function ze(e,t){let n=e.held;return delete e.held,n&&(n.pos=t??e.pos,Scene.appendChild(n.div),delete n.parent,g(n),g(e)),n}function tn(e,t){t&&(e.colors=t.colors,e.shape=t.shape,e.scale=t.scale),Ze(e)}function j(e,t=!0){return t?mn(we(e).pos):we(e).pos}function we(e){return e.parent?we(e.parent):e}function bt(e){return W(j(e)).dream}function nn(e,t,n=""){if(!t)return;let o=v[t];return y({...Q,shape:$e+o.ind,colors:o.colors,pos:f(e.pos,[0,0,-20]),className:"thought"+n,deadAt:Date.now()+3e3})}function on(e){return e.level??H(e.aspects)}function Ne(e){return e.kind==1?`${e.name} the ${e.type||"X"}`:`${e.material||""} ${e.type}`}function xt(e){if(e=="l"&&(e=he),!e||e.kind==4)return;let t="";if(t+=`<h1>${Ne(e)}</h1>`,t+=`<h4>Level ${S(on(e))}</h4>`,fn&&(t+=`<p>${e.tip||""} ${be[e.type]??be[e.use]??""} <i>${be[e.type]?"":be[e.kind]??""}</i></p>`),e.type=="Door"){let o="";e.material=="Obsidian"&&(o=`This door lets one person escape (use RMB). But they need to have level >= ${h(e).id}. Doing it also unlocks new room. You first character can only use the door in room 0.`),t+=`<p>${o}</p>`}e.aspects&&(t+="Aspects. ",e.kind==1&&(t+=`<i>This person's memories, personality and knowledge. Affects their performance while dreaming. 
Value after "/" is with equipment bonuses/penalties.</i>`),e.kind==2&&(t+=`<i>Characters automatically improve their aspects by looking at this item. 
The chance of learning something scales with the person's level and item's level.
The chance goes down, if many people have high value in this aspect.</i>`),t+=`${$t(e.aspects,e)}`);let n=h(e);return n.dream&&(t+="<div class=grid3>"+n.chars().map(o=>`<div>${S(o.level)}</div><div>${Ye(o)}</div><div>${pn(o)} ${o.combat.poison?o.combat.poison+" poison":""}</div>`).join("")+"</div>"),e.log?.length&&(t+="<hr/>"+e.log.join("")),t}function Ye(e){return`<u style='color:${e.dream?"#f88":"#8f8"}' onclick="selp(${e.id})">${Ne(e)}</u>`}window.selp=e=>R(x[e]);function Zn(e){let t=h(e).entities().filter(o=>o.use!="base"),n=pe(t.map(o=>{if(o==e||!dn(o))return 0;let r=Ae(e.pos,j(o));return on(o)/(10+r)*rn(e,o)}));return t[n]}function zn(e){return Object.fromEntries(Object.keys(v).map(t=>[t,m(e,t)]).filter(t=>t[1]))}function ut(e,t,n){let o=zn(t),r=M(o);n??=rn(e,t);let i=m(t,r)*n*.01;if(i=V(i),!!i&&(t.type=="Tome"&&(i*=1+m(e,"K")*.1),Ce(e.aspects,r,i),e.recent&&(e.recent.unshift(t.id),e.recent.length=20),e==he&&N(e),nn(t,r,"d"),ie(e,`Learned ${S(i)} of ${v[r].name} from ${Ne(t)} `),ie(t,`Taught ${S(i)} of ${v[r].name} to ${Ne(e)} `),t.type=="Clock"&&t.parent?.type=="Bed")){let a=h(e).chars().find(s=>s.sleeper)||e;(a.sleeper==0||a.sleeper>60)&&h(e).sleep(a,t.parent)}}function rn(e,t){e.recent??=[];let n=e.recent.indexOf(t.id);return n==-1&&(n=1e6),1-1/(1+n)}function sn(e){if(!Gn(e))return;if(e.held?.type=="Tome"){let n=e.held;ut(n,e,(n.level+m(e,"K")-H(n.aspects))*.05);return}let t=Zn(e);!t||Y(e,[...q(e,j(t),10),()=>ut(e,t),()=>ht(1e3)])}function Gn(e){return!e.actionsQueue?.length&&!e.animation}function an(e){let t=H(e.aspects),n=M(gt);if((se().length+3)*H(e.aspects)/(e.level+3)>c(100)){let r=.01*~~(t-e.level+1);e.aspects[n]=Math.max(0,e.aspects[n]-r),ie(e,`forgot ${S(r)} of ${v[n].name} `),nn(e,n)}}function ln(e){return h(e).dream}function Y(e,t){!e||(e.actionsQueue=t,delete e.animation)}function m(e,t){let n=e.aspects[t]||0;return e.parent&&e.parent.use=="base"&&(n=Math.min(n*2,n+(e.parent.aspects[t]||0))),e.kind==1&&(e.held||(n*=1.3),n+=(e.held?.aspects[t]||0)*.5,n+=(e.chest?.aspects[t]||0)*.5),n??0}function Be(e,t){e.title&&(e.title.innerHTML=t)}function pn(e){return e.combat?.hp>=0?`${S(e.combat?.hp)}/${re(e)} hp`:""}function Ee(e){Be(e,pn(e))}function Qt(){return M(ke,e=>e.chance)}function Kn(){return M(z,e=>e.chance)}function cn(e,t){let n=e.held;if(n?.type=="Shrinker"){t.scale*=.9,g(t);return}if(n?.type=="Magnifier"){t.scale/=.9,g(t);return}if(n?.type=="Hammer"&&t.kind==2){ut(e,t,10),T(t);return}if(n?.type=="Essense"){t.aspects=X(t.aspects,n.aspects),t.level=H(t.aspects),ze(e),T(n),g(e);return}if(n?.type=="Extractor"){let o=M(Pt(e.aspects,n.aspects)),r=Math.min(m(e,o)+n.aspects[o],t.aspects[o]);r>0?(y({...F,type:"Essense",material:t.material,aspects:{[o]:r},pos:t.pos}),T(t)):(ie(e,"Extract fail."),y({...Q,shape:58,colors:"32",pos:f(e.pos,[0,0,-20]),className:"thought",deadAt:Date.now()+3e3}),c(10)||T(t))}if(t.use=="armor"){e.chest.pos=t.pos,en(e.chest),t.parent&&K(t.parent,e.chest),T(t),g(e.chest),e.chest=t,g(e);return}if(n?.type=="Brush"){t.colors=n.colors,g(t);return}if(t.type=="Bed"){h(e).sleep(e,t);return}if(t.type=="Door"){let o=t.level;if(t.material=="Obsidian"){if(e.level<o){J(`Need level ${o} to use`);return}if(e.name=="\u041Ciu"){o==0?J("You win. Pretend there is an epic ending sequence here."):J("You can't use this door. Maybe you can find someone else who can?");return}Nn(t,"Wooden"),g(t),T(e),R(se()[0]),Nt(),G(),J(`Walking through this door, they have left these rooms for good. 
Also, new room has opened.`)}return}}function se(){return Te(!1).filter(e=>e.kind==1)}function Te(e){return Object.values(x).filter(t=>e===void 0||!t.dream==!e)}function dt(e){return f(e.pos,[-5+c(10),0,-35])}var vt=[],yn=600;function mn(e){return[e[0],e[1],Math.ceil(e[2]/128)*128]}function un(e,t){tn(Z,e),Z.pos=t,Scene.appendChild(Z.div),O(Z)}function ge(){Scene.style.left=`${oe[0]}px`,Scene.style.top=`${oe[1]}px`}function bn(){onkeydown=e=>{e.key=="Escape"&&(ue(),Msg.style.display="none")},onpointerup=e=>{vt[e.button]=!1},onpointerdown=e=>{vt[e.button]=!0;let[t,n,o,r]=hn(e),i=o=="f"?[t,n,(r+1)*128]:o=="B"?[t,0,n]:null,a;if(i&&W(i)?.dream&&e.button==2&&W(i).wake(),i&&p&&!p.dream&&o=="f"&&!e.shiftKey&&((e.button==2||e.button==0&&!p.held)&&(a=q(p,i)),e.button==0&&p.held&&(a=[...q(p,i),()=>ze(p)])),o=="s"&&!e.shiftKey){let s=x[r];if(!s)return;s.kind==1&&R(s)}if(p&&!p.dream&&o=="s"&&!e.shiftKey){let s=x[r];if(s&&s!=p){if(bt(s)){h(s).wake();return}e.button==2&&(a=[...q(p,j(s),15),()=>cn(p,s)]),e.button==0&&(s.kind==1?R(we(s)):a=[...q(p,j(s)),()=>{p.held?s.held||K(s,p.held):K(p,s)}])}}a&&!bt(p)&&Y(p,[...a,()=>ht(5e3)])},oncontextmenu=e=>{e.shiftKey||e.preventDefault()},onpointermove=e=>{if(vt[1]){let l=.5;Object.assign(oe,f(oe,[e.movementX,e.movementY],l)),ge()}let[t,n,o,r]=hn(e),i=[t,n,(r+1)*128],a=x[r];o=="s"?N(a):N(p);let s=p?.held;if(s&&(o=="f"&&un(s,i),o=="s"&&a&&a.kind==2)){let l=f(a.pos,[0,0,-je(a)[1]*.7]);un(s,l),a.div.parentElement?.appendChild(Z.div)}e.preventDefault()},onwheel=e=>{yn-=e.deltaY*.2,Et()}}var he;function dn(e){return e.kind==2||e.kind==1}var fn=!0;function N(e){let t=xt(e)||xt(p);he=e||p,Info.innerHTML=t??"",requestAnimationFrame(()=>document.querySelectorAll(".aspect").forEach(n=>{let o=v[n?.dataset?.aspect];if(!o)return;delete n?.dataset?.aspect;let r=yt({...Q,shape:$e+o.ind,colors:o.colors});n.prepend(r)}))}function Et(){Scene.style.transform=`translateZ(${yn}px)`}function hn(e){let[t,n,o]=[e.target.id,e.offsetX,e.offsetY],r=t[0],i=1*t.substring(1);return[n,o,r,i]}function xn(e){return[...e.matchAll(/(\w)(\w)(\w)/g)].map(t=>[...t.slice(1,4).map(n=>~~(Number.parseInt(n,36)/36*100)/100),1])}var gn="906j05u58zdczpdrfag867240125869i8lp8zu7zi8t94h34724i97wlfzuozzvqrrfjj68a13509d4kngtqzvuzjnq8kd3duzzxxx";var Xe={bitPos:[[3,1],[2,14],[2,10],[2,13]],mountPoint:[0,0,16],size:[16,24],origin:"75% 50%",kind:1,makeBits:e=>[[e.shape,e.colors],[Xt,e.colors],_t(e.chest),[Yt,e.colors]]},Se={bitPos:[[0,0]],size:[10,10],kind:3,makeBits:e=>e&&[[e.shape,e.colors]]},F={...Se,kind:2},Q={...Se,kind:4},zt=[,Xe,F,Se,Q],Ve=xn(gn),Ue=new Set,vi,vn,Ei,Z,Tn,p,x={};onload=()=>{img.onload=Wn,img.src="i.webp"};function R(e){let t=p;p=e,g(t),p&&(g(p),p.div.appendChild(Tn.div)),N(e)}var k=[];function Wn(){k=C(15,t=>new Oe(t)),jt(),k.forEach(t=>t.md()),Et(),bn(),ge(),vn=y({...Xe,shape:18,colors:"nm",type:"Cat",name:"\u041Ciu",chest:y({...F,type:"Chain",material:"Plant"}),pos:[320,10,128],addAspects:{S:1}}),Z=y({...Q,opacity:.5,shape:1,colors:"ab",pos:[0,0,0],noclick:!0});let e=["Bed","Bed","Hammer","Brush","Shrinker","Magnifier","Tome","Extractor"].map((t,n)=>y({...F,type:t,pos:k[n+1].center()}));K(e[1],y({...F,type:"Clock",pos:[0,0,0]})),Z.canvas.classList.add("phantom"),Tn=y({...Q,shape:8,colors:"ab",pos:[8,0,4],className:"pointer"}),R(vn),G(),setInterval(qn,15),N(),J("LMB to switch current character, walk around and pick/place items. RMB to use items (such as Bed). Middle buton and wheel to control the camera."),ue(localStorage[_])}var En=0,Tt=0,St=0,gt;function qn(){let e=Date.now(),t=Math.min(1e3,e-En||1);gt=se().reduce((o,r)=>X(o,r.aspects),{}),~~((St+t)/1e3)>~~(St/1e3)&&se().forEach(o=>{an(o),o.sleeper&&o.sleeper++}),St+=t,En=e;let n=Date.now();Tt=Tt*.9+1e3/t*.1,FPS.innerText=`FPS: ${~~Tt}`,Object.values(x).forEach(o=>{(o.actionsQueue.length||o.animation)&&O(o),o.deadAt&&n>o.deadAt&&T(o),o.kind==1&&!ln(o)&&t>c()*3e3&&sn(o)}),k.forEach(o=>{o.dream&&(o.dur+=t)}),p?.held||(Z.div.style.opacity="0")}})();
//# sourceMappingURL=bundle.js.map
