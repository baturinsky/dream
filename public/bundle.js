(()=>{function f(e,t,n=1){return e.map((o,r)=>o+t[r]*n)}function At(e,t=1){return e.map((n,o)=>n*t)}function xe(e,t){return f(e,t,-1)}function vn(e){return e.reduce((t,n)=>t+n*n,0)**.5}function ve(e,t){return vn(xe(t,e))}var ze=2**31,p=Ge(123);function Ge(e=0){0<e&&e<1&&(e=~~(e*ze));let t=n=>(e=e*16807%2147483647)%n;return p=n=>n==-1?e:n==null?t(ze)/ze:t(n),p}function F(e,t=p){if(!e)return null;let n=t(e.length);return e[n]}function te(e,t=p){let n=We(e),o=t()*n-e[0],r=0;for(;o>=0;)o-=e[++r];return r}function Ke(e,t,n=p){let o=e.map(t),r=te(o);return e[r]}function P(e,t=o=>o,n=p){let o=te(Object.values(e).map(t),n);return Object.keys(e)[o]}function We(e){return e.reduce((t,n)=>t- -n,0)}function Lt(e=p){let t="";for(let n=0;n<e(3)+2;n++)t+=F([..."kstnhmyrw",""],e)+F([..."aiueo",""],e);return En(t)}function En(e){return e?e[0].toUpperCase()+e.substring(1):""}function se(e){for(let t of Object.values(e))for(let n in t){let o=Number(t[n]);!isNaN(o)&&n!="colors"&&(t[n]=o)}return e}function le(e,t=p){return e=e*100,e=(e%1>t()?1:0)+~~e,e/=100}function R(e,t=n=>n){return[...new Array(~~Math.max(e,0))].map((n,o)=>t(o))}var qe=e=>new Promise(t=>setTimeout(t,e)),pe=e=>e&&e.toFixed(2).replace(/(.00)/g,"");var $=se(Object.fromEntries(`Health:So called Hit Points:31
Strength:Dealing Damage:fg
Resilience:Damage reduction:qp
Greed:Find More:c4
Bloom:Regeneration:ba
Courage:Cover your allies:21
Anger:Avenge Damage:uv
Mercy:Heal Friends:lx
Knowledge:Writing and Reading:mn
Light:Strike True:je
Dark:Evade:o8
Time:Action Rate:lm
Purity:Resist Poison:rq
Venom:Poison:ba`.split(`
`).map((e,t)=>{let[n,o,r]=e.split(":"),i=n[0];return[i,{l:i,name:n,tip:o,colors:r,ind:t}]}))),I=se(Object.fromEntries(`Wooden:67:H:10
Iron:32:S:10
Stone:mn:R:10
Golden:c4:G:2
Plant:ba:B:5
Leather:56:C:5
Bone:ji:A:5
Cloth:tv:M:10
Paper:kl:K:5
Glass:wr:L:5
Obsidian:no:D:2
Copper:ef:T:5
Silver:lx:P:3
Asbestos:kb:V:1
Abstract:::1`.split(`
`).map(e=>{let[t,n,o,r]=e.split(":");return[t,{colors:n,aspects:we(o),chance:r}]}))),Qe=23,j=se(Object.fromEntries(`Door:2:10:Wooden:0:1:
Bed:2:H:Wooden:10:.5:
Column:3:R:Stone:0:1:
Apple:1:B:Plant:10:1:
Chair:1.5:H:Wooden:10:1:
Chest:1:G:Wooden:10:1:
Shelf:2:G:Wooden:0:1:
Stand:2::Stone:0:1:
Display:2::Glass:0:1:
Plaque:2::Iron:0:1:
Big Table:2:R:Stone:0:1:
Display:2::Glass:0:1:
Dial:2::Glass:0:1:
Table:2::Wooden:10:.5:
Clock:1:T:Golden:1:1:
Pedestal:1::Wooden::1:
Mirror:2::Glass:5:1:
Angel:2:P:Silver:3:1:
Press:2::Iron:0:1:
Brush:1:::0:1:
Wine:1:A:Plant:5:1:


Shirt:1:T::1
Robe:1:M::1
Chain:1:S::1
Plate:1:R::1`.split(`
`).map((e,t)=>{let[n,o,r,i,s,a]=e.split(":");return[n,{armor:t>=Qe,type:n,scale:o,aspects:we(r),material:i,chance:s??0,ind:t,placeh:a}]})));console.log(j);var Te=se(Object.fromEntries(`Human:G
Elf:B
Cat:D
Ogre:H
Fairy:M
Bird:L
Rat:D
Raven:A
Skel:C
Imp:V
Dog:S
Hippo:H
Lizard:B
Drago:P
Alien:K
Hare:T`.split(`
`).map((e,t)=>{let[n,o]=e.split(":");return[n,{name:n,aspects:we(o),ind:t,chance:1/(10+t)}]}))),kt={...Te,...j},Se={1:"LMB to switch current character, walk around and pick/place items. RMB to use items (such as Bed).",2:"An item that you have found in the dream. Looking at it (happens automatically when awake) can help to remember something about reality (i.e. raise aspects).",Bed:"RMB to sleep. You can increase your level and find some items in dreams. What you find in the dream is affected by the room number and the aspects of the bed and the dreamer.",Brush:"Can recolor items"};function we(e=""){let t={};return[...e].forEach(n=>t[n]=(t[n]||0)+1),t}function Ae(e,t,n=1){let o={};e??={},t??={};for(let r in{...e,...t})o[r]=(e[r]||0)+(t[r]||0)*n;return o}function Ct(e,t){let n="";for(let o of Object.keys($)){let r=e[o]||0,i=t?u(t,o):r;i&&(n+=`<div class="aspect" data-aspect=${o}></div>
      <div class=num>${pe(r)} ${i!=r?`<i>/${pe(i)}</i>`:""}</div>
      <div> ${$[o].name}</div><div> <i>${$[o].tip}</i></div>`)}return`<p><div class=stats>${n}</div></p>`}function Z(e){return We(Object.values(e))}function Me(e,t,n){e[t]=(e[t]||0)+n}function Pt(e,t,n=1){let o=Z(e),r={...e};for(let i=o;i<t;i+=n)p(Object.keys(e).length+1)?Me(r,P(r),n):(Me(r,P(r),1),i+=1);return r}var z="ayhiadream";var Le=0;function $t(e){Le=e}function Dt(){return++Le}var S=256*2,x=128*2,lo=64*2-1,Je=(e,t,n)=>Tn(Mn(n,e),t),w=(e,t)=>Je("S",e,t),Rt=(e,t)=>Je("T",e,t),ne=(e,t)=>Je("O",e,t);function Tn(e,t){if(!e)debugger;if(!t)return e;let n=e.cloneNode();return h(n).filter=An(t),h(n).drawImage(e,0,0),n}var Sn=48,wn=64;var Ue=112;var ke=144,It=wn,Ot=Sn,Ht=16;function Mn(e,t,n=0){t=="O"&&(n=1);let o=_e(8+n*2);return o.id=t+e,h(o).filter=`url(#_${t})`,h(o).drawImage(img,e%Ht*8,~~(e/Ht)*8,8,8,n,n,8,8),o}function h(e){return e.getContext("2d")}function An(e){if(!Ve.has(e)){Ve.add(e);let[t,n]=[...e].map(r=>Ee[Number.parseInt(r,36)]),o=`<filter id=f${e}><feColorMatrix type=matrix values="${t[0]} ${n[0]} 0 0 0  ${t[1]} ${n[1]} 0 0 0  ${t[2]} ${n[2]} 0 0 0  0 0 0 1 0" /></filter>`;DEFS.innerHTML+=o}return`url(#f${e})`}function _e(e,t=e){let n=document.createElement("canvas");return n.classList.add("sprite"),n.width=e,n.height=t,n}var v=e=>h(e).createPattern(e,"repeat");function et(e,t,n){let o=document.createElement("div");o.classList.add("ftext"),n&&o.classList.add(n),o.innerHTML=`<div>${e}</div>`,Scene.appendChild(o),setTimeout(()=>Scene.removeChild(o),3e3),tt(o,t)}function tt(e,t,n=""){Object.assign(e.style,nt(t,n))}function nt(e,t=""){return{left:`${e[0]}px`,top:`${e[2]}px`,transform:`translateZ(${e[1]}px) `+t}}function g(e,t,n,o=1){let r=h(e);o&&(r.globalAlpha=o),r.fillStyle=t,r.fillRect(...n||[0,0,e.width,e.height]),o&&(r.globalAlpha=1)}function V(e,t,n,o=1){return e.width=t*o,e.height=n*o,e.style.width=`${t}px`,e.style.height=`${n}px`,e}function oe(e,t,n,o="canvas"){let r=document.createElement(o);return r.id=e,r.classList.add(...t.split(",")),Object.assign(r.style,n),Scene.appendChild(r),r}function Bt(e,t){let n=e.cloneNode();return n.width*=t,n.height*=t,Ce(n,e,0,0,t),n}function Ce(e,t,n,o,r=1){h(e).imageSmoothingEnabled=!1,h(e).drawImage(t,n,o,t.width*r,t.height*r)}var Ln,$e,rt;function Xt(){let e="";Scene.innerHTML+=e,V(Back,256*3,128*5,2);let t=v(w("gf",2));Ln=R(3+1,o=>{let r=oe(`w${o}`,"wall",{left:`${o*256}px`});return V(r,64,128*5,2),g(r,t),r}),$e=R(5+1,o=>V(oe(`f${o-1}`,"floor",{top:`${o*128}px`}),256*3,64,2));let n=$e.shift();g(n,v(w("87",2))),n.style.pointerEvents="none",rt=R(15,o=>V(oe(`c${o}`,"curtain",{top:`${~~(o/3)*128}px`,left:`${o%3*256}px`}),256,128,2)),K()}var kn="id,name,kind,pos,scale,right,shape,colors,aspects,dream,type,material,recent,level,combat,hrz,sleeper,log",O=1;function Nt(){O++}function at(e){return e&&{...Yt(e,kn),chest:at(e.chest),held:at(e.held)}}function Yt(e,t){return Object.fromEntries(t.split(",").map(n=>[n,e[n]]))}function st(e){if(!e)return null;let t=y({...Ft[e.kind],...e,chest:st(e.chest)});return e.held&&re(t,st(e.held),e.held.pos),t}function lt(){return{cur:l.id,lid:Le,openRoom:O,date:Date.now(),rooms:A.map(e=>Yt(e,"start,dream,aspects,level,stage,dur,drst")),all:Object.values(E).filter(e=>!e.parent&&e.kind!=4).map(e=>at(e))}}function pt(e){console.log(e),Object.values(E).forEach(t=>D(t)),e.all.forEach(t=>st(t)),J(E[e.cur]),$t(e.lid),O=e.openRoom,e.rooms.forEach((t,n)=>{Object.assign(A[n],t)}),K();for(let t of A)t.dream&&(t.tdr(!0),t.fight())}var it=!0;function ce(e){if(it=e===void 0?!it:e,!it){Saves.innerHTML="Press ESC to toggle menu";return}let t=JSON.parse(localStorage.getItem(z)||"[]");Saves.innerHTML=`<div class=saves>${R(10,n=>`<div>
    ${n||"auto"}</div><button onclick="save(${n})">Save</button>
 ${t[n]?`<button onclick="load(${n})">Load</button><div>${new Date(t[n].date).toUTCString()}</div>`:"<div></div><div></div>"}`).join("")} 
 </div>`}ce();window.save=e=>{let t=JSON.parse(localStorage[z]||"[]");t[e]=lt(),localStorage[z]=JSON.stringify(t),ce(!0)};window.load=e=>{let t=JSON.parse(localStorage[z]||"[]");pt(t[e]),ce(!1)};var He=class{constructor(t){this.id=t;this.stage=0;this.drst=0;this.dur=0;this.col=t%3,this.row=~~(t/3),this.l=256*this.col*2,this.t=128*this.row*2,this.pos=[t%3*256,0,128*~~(t/3+1)]}md(){y({...fe,shape:80,material:"Obsidian",type:"Door",level:this.id,scale:2,pos:this.doorPos()})}drawTrees(t){let n=[null,["a9",1],["ba",2],["a9",3],["57",16],0,["a9",7,1],["mn",9],["mn",8,1]],o=[0,4,4,4,0,4],r=h(Back);for(let i=60;i>4;i--){let s=2*i**.7,a=p(S*.9)+.1;r.save(),r.translate(a,x-s-70);let d=30/(3+s*.6);r.scale(d,d),o[t]&&Ce(Back,ne("57",Ue+o[t]),5,6),n[t]&&Ce(Back,ne(n[t][0],Ue+n[t][1]),0,-8,n[t][2]??2),r.restore()}}draw(){let t=$e[this.row],n=h(Back);if(Ge(this.id*99+(this.dream?this.stage+this.drst%1e3:0)),this.dream)if(this.stage%2){let i=F(Object.values(I)).colors,s=F(Object.values(I)).colors,a=v(w(i,p(5)+1));g(Back,a,[this.l,this.t,S,x]),g(t,v(w(s,p(3)+1)))}else{let i=p(8)+1,s=[0,["ba",9],["ba",9],["ba",9],["ba",9],["ij",9],["ij",13],["mn",14],["mn",14]][i],a=v(w(s[0],s[1]));n.save(),n.translate(this.l,this.t);let d=[["#00f","#f80"],["#88f","#00f"],["#008","#00f"]][p(3)],N=n.createLinearGradient(0,0,0,100);d.forEach((ye,ge)=>N.addColorStop(ge,ye)),n.fillStyle=N,n.fillRect(0,0,S,x),n.fillStyle=a,n.fillRect(0,0+x*.6,S,x*.4+3),this.drawTrees(i),n.restore();let Y=h(t);Y.save(),Y.translate(this.l,this.t),g(t,a,[0,0,S,x]);let be=Bt(Rt("45",11),16);g(t,v(be),[0,0,S,x],.5),Y.restore()}else{let i=v(w("2f",p(3)+1));g(Back,i,[this.l,this.t,S,x]),g(t,v(w("rq",p(3)+1)))}let o=v(w("2g",1)),r=rt[this.id];h(r).clearRect(0,0,S,x),this.open?(g(r,o,[0,0,10,x]),g(r,o,[0,x-10,S,10])):g(r,o,[0,0,S,x])}get open(){return this.id?this.id*1<=O:O>=13}tdr(t){this.dream=t,this.draw();for(let n of this.entities())L(n,[]),Ie(n,""),t||(n.combat={},n.dream&&D(n)),T(n),me(n)}entities(t){return ue(t).filter(n=>W(C(n))==this)}chars(t){return this.entities(t).filter(n=>n.kind==1)}doorPos(){return f(this.pos,[256/2,1,0])}async wake(){this.blind(),await qe(400),this.tdr(!1),this.stage=0,window.save(0)}async sleep(t){this.blind(),await qe(400),this.dur=0,this.drst=Date.now(),this.tdr(!0),this.aspects=t.aspects,this.level=t.level,this.next()}next(){for(let t=0;t<~~(this.stage/3)+1;t++){let n=y({...Oe,levelTo:this.level,type:Gt(),name:Lt(),chest:y({...ie,levelTo:this.level,type:F(Object.keys(j).slice(Qe))}),pos:this.doorPos(),dream:!0})}for(let t of[!0,!1]){let n=this.chars(t),o=f(this.pos,[(t?.3:.7)*256,0,0]);n.forEach((r,i)=>{r.pos=f(o,[0,((i+.5)/n.length*.7+.3)*64,0]),r.right=t,r.combat={pos:r.pos,hp:U(r),delay:Re(r),aggro:0},me(r),k(r)})}this.stage%2&&this.addItems(10,.2),this.fight()}win(){this.stage++,this.entities(!0).forEach(t=>{t.kind==2&&jt()?(t.dream=!1,T(t)):D(t)}),this.chars(!0).forEach(t=>D(t)),this.chars().forEach(t=>{t.combat.hp>0&&L(t,H(t,f(t.combat.pos,[-100,0,0])))}),this.blind(),this.chars()[0].actionsQueue.push(()=>this.next())}living(){return this.chars().filter(t=>t.combat.hp>0)}fight(){if(!this.dream)return;let t=this.living(),n=t.filter(a=>a.dream).length;if(n==0)return this.win();if(n==t.length)return this.wake();let o=Math.min(...t.map(a=>a.combat.delay)),r=t.find(a=>a.combat.delay==o),i=te([u(r,"S")+r.level*.1,u(r,"M")/2])==1,s;i&&(s=Ke(t,a=>ct(r,a)?U(a)/a.combat.hp:0)),(!s||Zt(s))&&(i==!1,s=Ke(t,a=>ct(r,a)?0:.1*a.level+Math.max(0,u(a,"C")-u(a,"D")-u(r,"L"))+u(r,"A")*a.combat.aggro)),L(r,zt(r,s,()=>t.forEach(a=>a.combat.delay-=o)))}blind(){let t=nt(f(this.pos,[0,64,-128])),n=oe("","blind",t);V(n,256,128,8),g(n,v(w("on",11))),setTimeout(()=>this.draw(),800),setTimeout(()=>Scene.removeChild(n),3900)}addItems(t,n=1){for(let o=0;o<t;o++){let r=P(j,s=>s.chance),i=y({...ie,type:r,levelTo:this.level+this.stage||10,pos:[this.col*256+10+p(256-20),p(64)*n,(this.row+1)*128]});i.level=Z(i.aspects),i.dream=this.dream,T(i)}}};function K(){A.forEach(e=>e.draw())}function W(e){return A[~~(e[0]/256)+3*~~(e[2]/128-1)]}function m(e){return W(C(e))||A[0]}function U(e){return~~((1+u(e,"H")+e.level*.5)*10)}function Re(e){return~~(1e3/(1+u(e,"T")+e.level*.1+p()))}function Cn(e){let t=m(e),n=1+t.dur/6e4;return e.dream?.5*n:1.5/n}function Pn(e,t){return(3+(u(e,"S")+e.level*.5)*3-u(t,"R")/2)*Cn(e)}function Wt(e,t){let n=e.dream==t.dream;n||L(t,qt(t));let o=Pn(e,t),r=!0;if(!n){let s=p()*(u(e,"L")*2+e.level)*2,a=p()*(u(t,"D")*2+t.level);r=s>a}let i=n?~~(2+u(e,"M")):-~~((p()+.5)*o);mt(t,i,r,e,u(e,"V")*.1)}function mt(e,t,n=!0,o=e,r=0){let i=Math.abs(t);n&&(e.combat.hp+=t,e.combat.hp=Math.min(Math.max(0,e.combat.hp),U(e)),o.combat.aggro+=i);let s=n?`${(t>0?"+":"")+t}`:"miss",a=n?t<0?"red":"grn":"";et(s,ut(e),a);let d=`<div class=${a}>${Be(o)} ${s} ${r?r+" poison":""} ${Be(e)}</div>`;e.combat.poison+=r,Kt(o,d),Kt(e,d),me(e);let N=m(e);e.combat.hp==0&&e.dream&&(N.chars(!1).forEach(Y=>$n(Y,Hn(Y,e))),Dn()&&(e.dream=!1,e.level=le(e.level*.7),N.wake()))}function Kt(e,t){e.log=e.log?.slice(0).slice(-5)??[],e.log.push(t),ae==e&&q(e)}function $n(e,t){t&&(e.level+=t,et(`${t}xp`,ut(e),"#80f"))}function Dn(){return p()<.5/_().length**2*O}function jt(){return p()<1/ue().filter(e=>e.kind==2&&!e.dream).length**2*O}function Hn(e,t){return Math.max(0,le((5+t.level-e.level)/(1+e.level)/m(e).chars(!1).length*.05))}function Zt(e){return e.combat.hp==U(e)}function ct(e,t){return e.dream==t.dream}var Rn="scaleX(-1) translateX(-100%)";var Qt=1,Xe=2,ft=3;function ee(e,t,n){let o=e.pos,r=Date.now(),{stopDistance:i,mode:s}=n||{};s??=Qt;let a=s==Xe?.3:.1,d=ve(e.pos,t)/a,N=t[0]-e.pos[0];N!=0&&s==Qt&&(e.right=N>0);let Y=xe(t,o);return()=>{let be=Date.now(),ye=Math.min(be-r,d);e.pos=f(o,Y,d?ye/d:1);let ge=ye>=d||ve(e.pos,t)<(i??0);return e.transform=ge?"":`rotateZ(${s==Xe?-10:s==ft?10:Math.sin(be/100)*5}deg)`,!ge}}function In(e){return e.right?1:-1}function H(e,t,n=0){let o=m(e),r=W(t);if(r==null)debugger;return r==o?[()=>ee(e,t,{stopDistance:n})]:[()=>ee(e,o.doorPos()),()=>e.pos=f(r.doorPos(),[5,0,0]),()=>ee(e,t,{stopDistance:n})]}function dt(e){let t=Date.now();return()=>Date.now()<t+e}function qt(e){return[()=>ee(e,f(e.combat.pos,[In(e)*-20,0,0]),{mode:ft}),()=>e.combat.hp?ee(e,e.combat.pos,{mode:ft}):null]}function zt(e,t,n=()=>{}){return[()=>ee(e,e==t?f(t.combat.pos,[0,0,-10]):t.combat.pos,{mode:Xe}),()=>{Wt(e,t),n()},()=>ee(e,e.combat.pos,{mode:Xe}),()=>{e.combat.delay=Re(e);let o=On(e)*e.combat.delay/1e3;o&&mt(e,o),m(e).fight()}]}function On(e){return u(e,"B")-e.combat.poison}function Ne(e){return[e.size[0]*e.scale,e.size[1]*e.scale]}function k(e){!e||(Ye(e),T(e))}function T(e,t){if(!e)return;if(!e.animation&&e.actionsQueue){let s=e.actionsQueue.shift();if(s){let a=s();a instanceof Function&&(e.animation=a)}}e.animation&&e.animation()==!1&&delete e.animation;let n=e.div,o=t?f(e.pos,t):e.pos,r=xe(o,Bn(e));n.style.opacity=e.opacity,n.classList.toggle("current",e==l),n.classList.add("k"+e.kind),n.classList.toggle("right",!!e.right),n.style.display=!e.dream&&m(e).dream&&e.kind!=1?"none":"block";let i=(e.right?Rn:"")+(e.transform??"")+(e.combat?.hp==0?"rotateZ(90deg)translateX(8px)":"");tt(n,r,i),e.type=="Door"&&Ie(e,`<div class='foo'>Room ${m(e).id}</div>`)}function Bn(e){return[Ne(e)[0]/2,0,Ne(e)[1]]}function ht(e){let t=_e(1),n=document.createElement("div");return n.classList.add("entity"),n.appendChild(t),n.style.position="absolute",t.id="s"+e.id,e.canvas=t,e.div=n,(e.kind==1||e.type=="Door")&&(e.title=document.createElement("div"),e.title.classList.add("etitle"),n.appendChild(e.title)),Ye(e),t}function Vt(e){return e&&[e.shape,e.colors]}function Ye(e){e.makeBits&&(e.bits=e.makeBits(e));let t=e.canvas,n=1;if(t.width=e.size[0]*n,t.height=e.size[1]*n,t.style.transformOrigin=e.origin,t.style.transform=`scale(${e.scale})`,h(t).imageSmoothingEnabled=!1,e.bits)for(let o=0;e.bits[o];o++){let r=e.bits[o];if(!r||!r[0])continue;let i=ne(r[1],r[0]);h(t).drawImage(i,e.bitPos[o][0]*n,e.bitPos[o][1]*n,i.width*n,i.height*n)}}function Xn(e,t){e.material=t,e.colors=I[e.material]?.colors}function y(e){e.id??=Dt();let t={canvas:ht(e),floor:0,actionsQueue:[],...e},n=kt[t.type];if(n&&(t.type??=n.type,n.placeh&&(t.mountPoint??=[5,0,9-n.placeh*8]),t.shape??=[0,16,80,0,0][t.kind]+n.ind,t.scale??=n.scale,t.armor??=n.armor,t.material??=p(2)||!n.material?jn():n.material),t.colors=t.colors||I[t.material]?.colors,t.scale??=1,t.log=[],Ye(t),t.pos&&(e.className&&t.div.classList.add(e.className),Jt(t)),!t.aspects)for(let o of[I[t.material],Te[t.type],j[t.type]])t.aspects=Ae(t.aspects,o?.aspects);return e.levelTo&&(t.aspects=Pt(t.aspects,e.levelTo)),t.level??=Z(t.aspects),t}function Jt(e){E[e.id]=e,Scene.appendChild(e.div),k(e)}function D(e){e.div.parentElement?.removeChild(e.div),delete E[e.id]}function re(e,t,n){t.kind==2&&(t.parent&&bt(t.parent),e.div.appendChild(t.div),e.held=t,t.parent=e,t.pos=n??At(e.mountPoint,e.scale),T(t))}function bt(e,t){let n=e.held;return delete e.held,n&&(n.pos=t??e.pos,Scene.appendChild(n.div),delete n.parent,k(n),k(e)),n}function Ut(e,t){t&&(e.colors=t.colors,e.shape=t.shape,e.scale=t.scale),Ye(e)}function C(e,t=!0){return t?rn(de(e).pos):de(e).pos}function de(e){return e.parent?de(e.parent):e}function he(e){return W(C(e)).dream}function Fe(e,t,n=1){if(!t)return;let o=$[t];return y({...B,shape:ke+o.ind,colors:o.colors,pos:f(e.pos,[0,0,-30*n]),className:"thought",deadAt:Date.now()+3e3})}function yt(e){return e.level??Z(e.aspects)}function Be(e){return e.kind==1?`${e.name} the ${e.type||"X"}`:`${e.material||""} ${e.type}`}function gt(e){if(e=="l"&&(e=ae),!e||e.kind==4)return;let t="";if(t+=`<h1>${Be(e)}</h1>`,t+=`<h4>Level ${pe(yt(e))}</h4>`,sn&&(t+=`<p>${e.tip||""} ${Se[e.type]??""}<i>${Se[e.type]?"":Se[e.kind]??""}</i></p>`),e.type=="Door"){let n="";e.material=="Obsidian"&&(n=`This door lets one person escape (use RMB). But they need to have level >= ${m(e).id}. Doing it also unlocks new room. You first character can only use the door in room 0.`),t+=`<p>${n}</p>`}return e.aspects&&(t+="Aspects. ",e.kind==1&&(t+=`<i>Aspects represent this person's memories, personality and knowledge. Affects their performance while dreaming. 
Value after "/" is with equipment bonuses/penalties.</i>`),e.kind==2&&(t+=`<i>Characters can improve their aspects by looking at this item (happens automatically, but in the current room only). 
The chance of learning something scales with the person's level and item's level, and goes down with the amount of already learned tinhgs.</i>`),t+=`${Ct(e.aspects,e)}`),t+=e.log.join(""),t}function Nn(e){let t=m(e).entities(),n=te(t.map(o=>{if(o==e||!an(o))return 0;let r=ve(e.pos,C(o));return yt(o)/(10+r)*_t(e,o)}));return t[n]}function Yn(e,t){let n=P(t.aspects),o=yt(t)*_t(e,t)*.01;o=le(o),o&&(Me(e.aspects,n,o),e.recent.unshift(t.id),e.recent.length=20,e==ae&&q(e),Fe(t,n))}function _t(e,t){e.recent??=[];let n=e.recent.indexOf(t.id);return n==-1&&(n=1e6),1-1/(1+n)}function en(e){if(!Fn(e))return;let t=Nn(e);!t||L(e,[...H(e,C(t),10),()=>Yn(e,t),()=>dt(1e3)])}function Fn(e){return!e.actionsQueue?.length&&!e.animation}function tn(e){let t=Z(e.aspects),n=P(xt);(_().length+3)*Z(e.aspects)/(e.level+3)>p(100)&&(e.aspects[n]=Math.max(0,e.aspects[n]-.01*~~(t-e.level+1)),Fe(e,n,-1))}function nn(e){return m(e).dream}function L(e,t){!e||(e.actionsQueue=t,delete e.animation)}function u(e,t){let n=e.aspects[t]||0;return e.kind==1&&!e.held&&(n*=1.3),n+=(e.held?.aspects[t]||0)*.5,n+=(e.chest?.aspects[t]||0)*.5,n??0}function Ie(e,t){e.title&&(e.title.innerHTML=t)}function me(e){Ie(e,e.combat?.hp>=0?`${e.combat?.hp}/${U(e)} hp`:"")}function Gt(){return P(Te,e=>e.chance)}function jn(){return P(I,e=>e.chance)}function on(e,t){if(t.armor&&(e.chest.pos=t.pos,Jt(e.chest),t.parent&&re(t.parent,e.chest),D(t),e.chest=t,k(e)),t.type=="Door"){let o=m(t).id;if(t.material=="Obsidian"){if(e.level<o){alert(`Need level ${o} to use`);return}if(e.tip=="This is you."){alert("You can't use this door. Maybe you can find someone else who can?");return}Xn(t,"Wooden"),k(t),D(e),J(_()[0]),Nt(),K(),alert(`Walking through this door, they have left these rooms for good. 
Have they went to the real world, or just disappeared? Who knows.
Also, new room has opened.`)}return}let n=e.held;if(n?.type=="Brush"){t.colors=n.colors,k(t);return}t.type=="Bed"&&m(e).sleep(e)}function _(){return ue(!1).filter(e=>e.kind==1)}function ue(e){return Object.values(E).filter(t=>e===void 0||!t.dream==!e)}function ut(e){return f(e.pos,[-5+p(10),0,-35])}var vt=[],je=[-380,20],pn=600;function rn(e){return[e[0],e[1],Math.ceil(e[2]/128)*128]}function ln(e,t){Ut(X,e),X.pos=t,Scene.appendChild(X.div),T(X)}function Et(){Scene.style.left=`${je[0]}px`,Scene.style.top=`${je[1]}px`}function cn(){onkeydown=e=>{e.key=="Escape"&&ce()},onpointerup=e=>{vt[e.button]=!1},onpointerdown=e=>{vt[e.button]=!0;let[t,n,o,r]=Ze(e),i=[t,n,(r+1)*128],s;if(l&&o=="f"&&!e.shiftKey&&(W(i)?.dream&&W(i).wake(),(e.button==2||e.button==0&&!l.held)&&(s=H(l,i)),e.button==0&&l.held&&(s=[...H(l,i),()=>bt(l)])),l&&o=="s"&&!e.shiftKey){let a=E[r];if(a&&a!=l){if(he(a)){m(a).wake();return}e.button==2&&(s=[...H(l,C(a),15),()=>on(l,a)]),e.button==0&&(a.kind==1?J(de(a)):s=[...H(l,C(a)),()=>{l.held?a.held||re(a,l.held):re(l,a)}])}}s&&!he(l)&&L(l,[...s,()=>dt(5e3)])},oncontextmenu=e=>{e.shiftKey||e.preventDefault()},onpointermove=e=>{if(vt[1]){let d=.5;je=f(je,[e.movementX,e.movementY],d),Et()}let[t,n,o,r]=Ze(e),i=[t,n,(r+1)*128],s=E[r];o=="s"?q(s):q(l);let a=l?.held;if(a&&(o=="f"&&ln(a,i),o=="s"&&s&&s.kind==2)){let d=f(s.pos,[0,0,-Ne(s)[1]*.7]);ln(a,d),s.div.parentElement?.appendChild(X.div)}e.preventDefault()},onwheel=e=>{pn-=e.deltaY*.2,Tt()}}var ae;function an(e){return e.kind==2||e.kind==1}var sn=!0;function q(e){let t=gt(e)||gt(l);ae=e||l,Info.innerHTML=t??"",requestAnimationFrame(()=>document.querySelectorAll(".aspect").forEach(n=>{let o=$[n?.dataset?.aspect];if(!o)return;delete n?.dataset?.aspect;let r=ht({...B,shape:ke+o.ind,colors:o.colors});n.prepend(r)}))}function Tt(){Scene.style.transform=`translateZ(${pn}px)`}function Ze(e){let[t,n,o]=[e.target.id,e.offsetX,e.offsetY],r=t[0],i=1*t.substring(1);return[n,o,r,i]}function St(e){return[...e.matchAll(/(\w)(\w)(\w)/g)].map(t=>[...t.slice(1,4).map(n=>~~(Number.parseInt(n,36)/36*100)/100),1])}var mn="906j05u58zdczpdrfag867240125869i8lp8zu7zi8t94h34724i97wlfzuozzvqrrfjj68a13509d4kngtqzvuzjnq8kd3duzzxxx";var dn=1,hn=2,bn=0;addEventListener("pointerdown",e=>{let[t,n,o,r]=Ze(e);if(o=="f"&&e.button==0&&e.shiftKey){let s=fn();s.pos=[t,n,r*128],T(s)}o=="O"&&(bn=r),o=="C"&&(e.button==0?dn=r:hn=r),Preview.innerHTML="";let i=fn();Preview.appendChild(i.canvas)});var un=0;addEventListener("keydown",e=>{if(e.code=="KeyD"&&Debug.classList.toggle("dn"),e.code=="KeyS"){let t=lt();console.log(t),localStorage.setItem(z,JSON.stringify(t))}if(e.code=="KeyL"){let t=localStorage.getItem(z);t&&pt(JSON.parse(t))}if(e.code=="KeyT"){let t=m(l).entities(),n=F(t);L(l,H(l,C(n),15))}if(e.code=="KeyE"){let t=Object.keys($)[un];Fe(l,t),un++}e.code=="KeyN"&&(he(l)?m(l).wake():m(l).sleep(l))});function fn(){return y({...B,shape:bn,colors:dn+""+hn,pos:[0,0,0]})}var Oe={bitPos:[[3,1],[2,14],[2,10],[2,13]],mountPoint:[0,0,16],size:[16,24],origin:"75% 50%",kind:1,makeBits:e=>[[e.shape,e.colors],[It,e.colors],Vt(e.chest),[Ot,e.colors]]},fe={bitPos:[[0,0]],size:[10,10],kind:3,makeBits:e=>e&&[[e.shape,e.colors]]},ie={...fe,kind:2},B={...fe,kind:4},Ft=[,Oe,ie,fe,B],Ee=St(mn),Ve=new Set,Di,yn,Hi,X,xn,l,E={};onload=()=>{e:console.log(123);img.onload=Zn,img.src="16cols.gif"};function J(e){let t=l;l=e,k(t),l&&(k(l),l.div.appendChild(xn.div))}var A=[];function Zn(){A=R(15,e=>new He(e)),Xt(),A.forEach(e=>e.md()),Tt(),cn(),Et(),yn=y({...Oe,level:1,shape:18,colors:"nm",type:"Cat",name:"Miu",chest:y({...ie,type:"Shirt",material:"Iron"}),pos:[320,10,128],tip:"This is you."}),y({...ie,type:"Bed",material:"Wooden",pos:[384,32,128]}),X=y({...B,opacity:.5,shape:1,colors:"ab",pos:[0,0,0],noclick:!0}),X.canvas.classList.add("phantom"),xn=y({...B,shape:8,colors:"ab",pos:[8,0,4],className:"pointer"}),J(yn),K(),setInterval(zn,15),q()}var gn=0,wt=0,Mt=0,xt;function zn(){let e=Date.now(),t=Math.min(1e3,e-gn||1);xt=_().reduce((o,r)=>Ae(o,r.aspects),{}),~~((Mt+t)/1e3)>~~(Mt/1e3)&&_().forEach(tn),Mt+=t,gn=e;let n=Date.now();wt=wt*.9+1e3/t*.1,FPS.innerText=`FPS: ${~~wt}`,Object.values(E).forEach(o=>{(o.actionsQueue.length||o.animation)&&T(o),o.deadAt&&n>o.deadAt&&D(o),o.kind==1&&!nn(o)&&t>p()*3e3&&en(o)}),A.forEach(o=>{o.dur&&(o.dur+=t)}),l?.held||(X.div.style.opacity="0")}})();
//# sourceMappingURL=bundle.js.map
